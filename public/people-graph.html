<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>People Graph - RCM Intelligence</title>
    
    <!-- D3.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
            color: #1F2937;
            overflow-x: hidden;
        }

        .header {
            background: #FFFFFF;
            border-bottom: 2px solid #2B5BA6;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 8px rgba(17, 27, 46, 0.08);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 65px;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #111B2E;
            letter-spacing: -0.3px;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .nav a {
            color: #111B2E;
            text-decoration: none;
            padding: 8px 16px;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .nav a:hover {
            background: #F9FAFB;
            border-color: #2B5BA6;
            color: #2B5BA6;
        }

        .nav a.active {
            background: #2B5BA6;
            color: white;
            border-color: #2B5BA6;
        }

        .company-badge {
            background: linear-gradient(135deg, #2B5BA6 0%, #5BA5D6 100%);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .container {
            padding: 30px 40px;
            margin-top: 65px;
        }

        .page-header {
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            color: #2B5BA6;
            margin-bottom: 12px;
        }

        .page-description {
            color: #6B7280;
            font-size: 16px;
            line-height: 1.6;
        }

        .stats-bar {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .stat-box {
            background: linear-gradient(135deg, #F3F4F6 0%, #E5E7EB 100%);
            padding: 15px 25px;
            border-radius: 12px;
            border-left: 4px solid #2B5BA6;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: #2B5BA6;
        }

        .stat-label {
            font-size: 13px;
            color: #6B7280;
            margin-top: 4px;
        }

        .org-chart-container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            min-height: 800px;
            overflow: auto;
        }

        .node circle {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .node circle:hover {
            stroke-width: 4px;
            filter: brightness(1.1);
        }

        .node text {
            font-family: 'Segoe UI', sans-serif;
            font-size: 12px;
            font-weight: 600;
            text-anchor: middle;
        }

        .node .name-text {
            font-size: 13px;
            font-weight: 600;
            fill: #1F2937;
        }

        .node .title-text {
            font-size: 11px;
            font-weight: 400;
            fill: #6B7280;
        }

        .node .kpi-count {
            font-size: 10px;
            font-weight: 600;
            fill: #2B5BA6;
        }

        .link {
            fill: none;
            stroke: #9CA3AF;
            stroke-width: 2px;
        }

        /* Detail Panel */
        .detail-panel {
            position: fixed;
            right: -600px;
            top: 0;
            width: 600px;
            height: 100vh;
            background: white;
            box-shadow: -4px 0 20px rgba(0,0,0,0.15);
            transition: right 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            overflow-y: auto;
        }

        .detail-panel.open {
            right: 0;
        }

        .detail-header {
            background: linear-gradient(135deg, #2B5BA6 0%, #1E4A8C 100%);
            color: white;
            padding: 30px;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .close-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .person-profile {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 10px;
        }

        .profile-image-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
        }

        .person-info h2 {
            font-size: 24px;
            margin-bottom: 6px;
        }

        .person-info .person-title {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 4px;
        }

        .person-info .person-department {
            font-size: 13px;
            opacity: 0.8;
        }

        .contact-info {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            font-size: 13px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .detail-content {
            padding: 30px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #E5E7EB;
        }

        .kpi-grid {
            display: grid;
            gap: 20px;
        }

        .kpi-mini-card {
            background: linear-gradient(135deg, #F9FAFB 0%, #F3F4F6 100%);
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #2B5BA6;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .kpi-mini-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(43, 91, 166, 0.15);
            border-left-width: 6px;
        }

        .kpi-mini-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .kpi-name {
            font-size: 15px;
            font-weight: 600;
            color: #1F2937;
        }

        .kpi-rag-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .kpi-rag-badge.red { background: #FEE2E2; color: #2B5BA6; }
        .kpi-rag-badge.amber { background: #FEF3C7; color: #D97706; }
        .kpi-rag-badge.green { background: #D1FAE5; color: #059669; }

        .kpi-metrics {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .kpi-metric {
            flex: 1;
        }

        .kpi-metric-label {
            font-size: 11px;
            color: #6B7280;
            margin-bottom: 4px;
        }

        .kpi-metric-value {
            font-size: 18px;
            font-weight: 700;
            color: #2B5BA6;
        }

        .kpi-metric-target {
            font-size: 13px;
            color: #6B7280;
        }

        .view-details-btn {
            margin-top: 12px;
            padding: 8px 16px;
            background: white;
            border: 2px solid #2B5BA6;
            color: #2B5BA6;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            width: 100%;
        }

        .view-details-btn:hover {
            background: #2B5BA6;
            color: white;
        }

        /* KPI Detail Modal */
        .kpi-detail-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .kpi-detail-modal.show {
            display: flex;
        }

        .kpi-detail-content {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .kpi-layer-section {
            padding: 20px;
            border-bottom: 1px solid #E5E7EB;
        }

        .kpi-layer-section:last-child {
            border-bottom: none;
        }

        .kpi-layer-section h4 {
            color: #2B5BA6;
            font-size: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .layer-icon {
            font-size: 20px;
        }

        .zoom-controls {
            position: fixed;
            bottom: 30px;
            right: 30px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 50;
        }

        .zoom-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: white;
            border: 2px solid #2B5BA6;
            color: #2B5BA6;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .zoom-btn:hover {
            background: #2B5BA6;
            color: white;
            transform: scale(1.1);
        }

        .legend {
            position: fixed;
            bottom: 30px;
            left: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 50;
        }

        .legend-title {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 12px;
            color: #1F2937;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
            font-size: 12px;
            color: #6B7280;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 3px solid;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <h1>RCM Intelligence</h1>
        </div>
        <div class="nav">
            <a href="index.html">Executive Advisor</a>
            <a href="control-center.html">KPI Control Center</a>
            <a href="command-center.html">Command Center</a>
            <a href="people-graph.html" class="active">People Graph</a>
            <a href="automation-hub.html">ðŸ¤– Automation Hub</a>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">
        <!-- Page Header -->
        <div class="page-header">
            <h1 class="page-title">ðŸ‘¥ Organizational People Graph</h1>
            <p class="page-description">
                Explore the organizational hierarchy from CEO to individual contributors, with each person's KPI ownership and accountability.
                Click on any person to see their profile, assigned KPIs, and performance details.
            </p>
            <div class="stats-bar">
                <div class="stat-box">
                    <div class="stat-value" id="total-people">28</div>
                    <div class="stat-label">Total Employees</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-departments">6</div>
                    <div class="stat-label">Departments</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-kpis-assigned">101</div>
                    <div class="stat-label">KPIs Assigned</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="org-depth">4</div>
                    <div class="stat-label">Organization Levels</div>
                </div>
            </div>
        </div>

        <!-- Org Chart -->
        <div class="org-chart-container">
            <svg id="org-chart"></svg>
        </div>
    </div>

    <!-- Detail Panel -->
    <div class="detail-panel" id="detailPanel">
        <div class="detail-header">
            <button class="close-btn" onclick="closeDetailPanel()">Ã—</button>
            <div id="personProfileHeader"></div>
        </div>
        <div class="detail-content" id="detailContent"></div>
    </div>

    <!-- KPI Detail Modal -->
    <div class="kpi-detail-modal" id="kpiDetailModal">
        <div class="kpi-detail-content" id="kpiDetailContent"></div>
    </div>

    <!-- Zoom Controls -->
    <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomIn()">+</button>
        <button class="zoom-btn" onclick="zoomOut()">âˆ’</button>
        <button class="zoom-btn" onclick="resetZoom()" style="font-size: 20px;">âŸ²</button>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-title">Organization Levels</div>
        <div class="legend-item">
            <div class="legend-color" style="border-color: #2B5BA6; background: #FEE2E2;"></div>
            <span>Executive Leadership</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="border-color: #D97706; background: #FEF3C7;"></div>
            <span>Vice Presidents</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="border-color: #2563EB; background: #DBEAFE;"></div>
            <span>Directors</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="border-color: #059669; background: #D1FAE5;"></div>
            <span>Managers & Staff</span>
        </div>
    </div>

    <script>
        let peopleData = null;
        let kpiData = null;
        let svg, g, zoom;

        // Load data
        async function loadData() {
            try {
                const [peopleResponse, kpiResponse] = await Promise.all([
                    fetch('people_data.json'),
                    fetch('kpi_map.json')
                ]);
                
                peopleData = await peopleResponse.json();
                kpiData = await kpiResponse.json();
                
                initializeOrgChart();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function initializeOrgChart() {
            const container = document.getElementById('org-chart');
            const width = container.parentElement.clientWidth;
            const height = 1200;

            // Create SVG with zoom
            svg = d3.select('#org-chart')
                .attr('width', width)
                .attr('height', height);

            // Define zoom behavior
            zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            g = svg.append('g')
                .attr('transform', 'translate(0,0)');

            // Create tree layout
            const tree = d3.tree()
                .size([width - 200, height - 200])
                .separation((a, b) => {
                    return a.parent === b.parent ? 1 : 1.2;
                });

            // Create hierarchy
            const root = d3.hierarchy(peopleData.hierarchy);
            tree(root);

            // Center the tree
            const offsetX = width / 2;
            const offsetY = 80;
            
            root.each(d => {
                d.x = d.x - (width - 200) / 2 + offsetX;
                d.y = d.y + offsetY;
            });

            // Draw links
            const links = g.selectAll('.link')
                .data(root.links())
                .enter()
                .append('path')
                .attr('class', 'link')
                .attr('d', d3.linkVertical()
                    .x(d => d.x)
                    .y(d => d.y));

            // Create nodes
            const nodes = g.selectAll('.node')
                .data(root.descendants())
                .enter()
                .append('g')
                .attr('class', 'node')
                .attr('transform', d => `translate(${d.x},${d.y})`)
                .on('click', (event, d) => showPersonDetail(d.data));

            // Add profile image circles with clipping
            nodes.append('defs')
                .append('clipPath')
                .attr('id', d => `clip-${d.data.id}`)
                .append('circle')
                .attr('r', 30);

            // Add background circle (border)
            nodes.append('circle')
                .attr('r', 32)
                .attr('fill', d => getLevelColor(d.data.level))
                .attr('stroke', d => getLevelColorDark(d.data.level))
                .attr('stroke-width', 3);

            // Add profile image
            nodes.append('image')
                .attr('xlink:href', d => d.data.profile_image)
                .attr('x', -30)
                .attr('y', -30)
                .attr('width', 60)
                .attr('height', 60)
                .attr('clip-path', d => `url(#clip-${d.data.id})`);

            // Add name
            nodes.append('text')
                .attr('class', 'name-text')
                .attr('dy', 50)
                .text(d => d.data.name);

            // Add title
            nodes.append('text')
                .attr('class', 'title-text')
                .attr('dy', 65)
                .text(d => d.data.title);

            // Add KPI count badge
            nodes.append('text')
                .attr('class', 'kpi-count')
                .attr('dy', 78)
                .text(d => `${d.data.kpi_ownership.length} KPIs`);

            // Initial zoom to fit
            const bounds = g.node().getBBox();
            const fullWidth = width;
            const fullHeight = height;
            const midX = bounds.x + bounds.width / 2;
            const midY = bounds.y + bounds.height / 2;
            
            const scale = 0.9 / Math.max(bounds.width / fullWidth, bounds.height / fullHeight);
            const translate = [fullWidth / 2 - scale * midX, fullHeight / 2 - scale * midY];

            svg.transition()
                .duration(750)
                .call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
        }

        function getLevelColor(level) {
            const colors = ['#FEE2E2', '#FEF3C7', '#DBEAFE', '#D1FAE5'];
            return colors[level] || colors[3];
        }

        function getLevelColorDark(level) {
            const colors = ['#2B5BA6', '#D97706', '#2563EB', '#059669'];
            return colors[level] || colors[3];
        }

        function showPersonDetail(person) {
            const panel = document.getElementById('detailPanel');
            const header = document.getElementById('personProfileHeader');
            const content = document.getElementById('detailContent');

            // Build header
            header.innerHTML = `
                <div class="person-profile">
                    <img src="${person.profile_image}" alt="${person.name}" class="profile-image-large">
                    <div class="person-info">
                        <h2>${person.name}</h2>
                        <div class="person-title">${person.title}</div>
                        <div class="person-department">${person.department}</div>
                    </div>
                </div>
                <div class="contact-info">
                    <div class="contact-item">
                        <span>ðŸ“§</span>
                        <span>${person.email}</span>
                    </div>
                    <div class="contact-item">
                        <span>ðŸ“ž</span>
                        <span>${person.phone}</span>
                    </div>
                </div>
            `;

            // Build KPI cards
            const kpis = person.kpi_ownership.map(kpiId => {
                return kpiData.nodes.find(n => n.id === kpiId);
            }).filter(kpi => kpi); // Filter out nulls

            let kpiHtml = `
                <div class="section-title">ðŸ“Š KPI Ownership (${kpis.length} KPIs)</div>
                <div class="kpi-grid">
            `;

            kpis.forEach(kpi => {
                kpiHtml += `
                    <div class="kpi-mini-card" onclick="showKPIDetail('${kpi.id}')">
                        <div class="kpi-mini-header">
                            <div class="kpi-name">${kpi.name}</div>
                            <span class="kpi-rag-badge ${kpi.rag}">${kpi.rag.toUpperCase()}</span>
                        </div>
                        <div class="kpi-metrics">
                            <div class="kpi-metric">
                                <div class="kpi-metric-label">Current</div>
                                <div class="kpi-metric-value">${kpi.value}</div>
                            </div>
                            <div class="kpi-metric">
                                <div class="kpi-metric-label">Target</div>
                                <div class="kpi-metric-target">${kpi.target}</div>
                            </div>
                            <div class="kpi-metric">
                                <div class="kpi-metric-label">Trend</div>
                                <div class="kpi-metric-target">${kpi.trend}</div>
                            </div>
                        </div>
                        <button class="view-details-btn">View 10-Layer Intelligence â†’</button>
                    </div>
                `;
            });

            kpiHtml += '</div>';
            content.innerHTML = kpiHtml;

            panel.classList.add('open');
        }

        function closeDetailPanel() {
            document.getElementById('detailPanel').classList.remove('open');
        }

        function showKPIDetail(kpiId) {
            const kpi = kpiData.nodes.find(n => n.id === kpiId);
            if (!kpi) return;

            const modal = document.getElementById('kpiDetailModal');
            const content = document.getElementById('kpiDetailContent');

            // Build complete 10-layer intelligence card (same as other pages)
            const currentValue = kpi.value;
            
            let html = `
                <div class="detail-header">
                    <button class="close-btn" onclick="closeKPIModal()">Ã—</button>
                    <h2>${kpi.name}</h2>
                    <div style="margin-top: 10px; font-size: 14px;">
                        <span style="opacity: 0.9;">Current: <strong>${currentValue}</strong></span>
                        <span style="margin-left: 20px; opacity: 0.9;">Target: <strong>${kpi.target}</strong></span>
                        <span style="margin-left: 20px; opacity: 0.9;">Trend: <strong>${kpi.trend}</strong></span>
                    </div>
                </div>

                <div class="kpi-layer-section">
                    <h4><span class="layer-icon">ðŸ“‹</span> Context & Business Impact</h4>
                    <p style="color: #4B5563; line-height: 1.6;">${kpi.context}</p>
                </div>

                <div class="kpi-layer-section">
                    <h4><span class="layer-icon">ðŸ“Š</span> Current State Analysis</h4>
                    <p style="color: #4B5563; line-height: 1.6;">${kpi.current_state}</p>
                </div>

                <div class="kpi-layer-section">
                    <h4><span class="layer-icon">ðŸ“ˆ</span> Historical Trends (6 Months)</h4>
                    <div style="height: 150px; margin-top: 12px;">
                        <canvas id="trend-sparkline-modal"></canvas>
                    </div>
                </div>
            `;

            // Add more layers if available
            if (kpi.root_causes && kpi.root_causes.length > 0) {
                html += `
                    <div class="kpi-layer-section">
                        <h4><span class="layer-icon">ðŸŽ¯</span> Root Cause Analysis</h4>
                        ${kpi.root_causes.map((rc, i) => `
                            <div style="background: ${rc.impact === 'High' ? '#FEE2E2' : rc.impact === 'Medium' ? '#FEF3C7' : '#D1FAE5'}; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <strong>Root Cause #${i + 1}:</strong> ${rc.cause}<br>
                                <span style="font-size: 12px; color: #6B7280;">
                                    Impact: ${rc.impact} | Confidence: ${rc.confidence} | Data Points: ${rc.data_points}
                                </span>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // Add recommended actions
            if (kpi.recommended_actions && kpi.recommended_actions.length > 0) {
                html += `
                    <div class="kpi-layer-section">
                        <h4><span class="layer-icon">âœ…</span> Recommended Actions</h4>
                        ${kpi.recommended_actions.map((action, i) => `
                            <div style="background: #F9FAFB; padding: 15px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ${action.priority === 'Critical' ? '#2B5BA6' : action.priority === 'High' ? '#D97706' : '#059669'};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <strong style="color: #1F2937;">Action ${i + 1}: ${action.action}</strong>
                                    <span style="background: ${action.priority === 'Critical' ? '#FEE2E2' : action.priority === 'High' ? '#FEF3C7' : '#D1FAE5'}; color: ${action.priority === 'Critical' ? '#2B5BA6' : action.priority === 'High' ? '#D97706' : '#059669'}; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 600;">
                                        ${action.priority}
                                    </span>
                                </div>
                                <p style="color: #6B7280; font-size: 13px; margin-bottom: 8px;">${action.description}</p>
                                <div style="display: flex; gap: 15px; font-size: 12px; color: #6B7280;">
                                    <span><strong>Timeline:</strong> ${action.timeline}</span>
                                    <span><strong>Owner:</strong> ${action.owner}</span>
                                </div>
                                ${action.expected_impact ? `
                                    <div style="margin-top: 8px; padding: 8px; background: white; border-radius: 6px; font-size: 12px;">
                                        <strong style="color: #059669;">Expected Impact:</strong> ${action.expected_impact}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            content.innerHTML = html;
            modal.classList.add('show');

            // Draw trend chart
            if (kpi.trend_data && kpi.trend_data.length > 0) {
                setTimeout(() => drawTrendChart(kpi.trend_data), 100);
            }
        }

        function closeKPIModal() {
            document.getElementById('kpiDetailModal').classList.remove('show');
        }

        function drawTrendChart(trendData) {
            const canvas = document.getElementById('trend-sparkline-modal');
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(d => d.month),
                    datasets: [{
                        label: 'Performance',
                        data: trendData.map(d => d.value),
                        borderColor: '#2B5BA6',
                        backgroundColor: 'rgba(43, 91, 166, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // Zoom functions
        function zoomIn() {
            svg.transition().duration(300).call(zoom.scaleBy, 1.3);
        }

        function zoomOut() {
            svg.transition().duration(300).call(zoom.scaleBy, 0.7);
        }

        function resetZoom() {
            svg.transition().duration(750).call(zoom.transform, d3.zoomIdentity);
        }

        // Close modal on outside click
        document.getElementById('kpiDetailModal').addEventListener('click', (e) => {
            if (e.target.id === 'kpiDetailModal') {
                closeKPIModal();
            }
        });

        // Initialize
        loadData();
    </script>
</body>
</html>
