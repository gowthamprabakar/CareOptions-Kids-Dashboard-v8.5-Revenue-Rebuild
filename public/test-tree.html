<!DOCTYPE html>
<html>
<head>
    <title>Tree Test</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <style>
        body { margin: 20px; font-family: Arial; }
        #tree { width: 100%; height: 800px; border: 1px solid #ccc; overflow: scroll; }
        .node circle { fill: #69b3a2; stroke: #333; stroke-width: 2px; }
        .node text { font-size: 12px; }
        .link { fill: none; stroke: #999; stroke-width: 1.5px; }
    </style>
</head>
<body>
    <h1>D3 Tree Test</h1>
    <div id="status">Loading...</div>
    <div id="tree"></div>
    
    <script>
        fetch('kpi_map.json')
            .then(r => r.json())
            .then(data => {
                document.getElementById('status').innerHTML = `
                    ✅ Data loaded: ${data.total_nodes} nodes<br>
                    Tree children: ${data.tree.children.length}<br>
                    Rendering...
                `;
                
                // Simple D3 tree
                const width = 1200;
                const height = 800;
                
                const svg = d3.select('#tree')
                    .append('svg')
                    .attr('width', width)
                    .attr('height', height);
                
                const g = svg.append('g')
                    .attr('transform', 'translate(100, 50)');
                
                const tree = d3.tree().size([height - 100, width - 200]);
                const root = d3.hierarchy(data.tree);
                
                tree(root);
                
                // Links
                g.selectAll('.link')
                    .data(root.links())
                    .enter().append('path')
                    .attr('class', 'link')
                    .attr('d', d3.linkHorizontal()
                        .x(d => d.y)
                        .y(d => d.x));
                
                // Nodes
                const node = g.selectAll('.node')
                    .data(root.descendants())
                    .enter().append('g')
                    .attr('class', 'node')
                    .attr('transform', d => `translate(${d.y},${d.x})`);
                
                node.append('circle')
                    .attr('r', 5);
                
                node.append('text')
                    .attr('dy', 3)
                    .attr('x', d => d.children ? -8 : 8)
                    .style('text-anchor', d => d.children ? 'end' : 'start')
                    .text(d => d.data.name.split('\\n')[0].substring(0, 30));
                
                document.getElementById('status').innerHTML += `<br>✅ Rendered ${root.descendants().length} nodes`;
            })
            .catch(err => {
                document.getElementById('status').innerHTML = `❌ Error: ${err.message}`;
            });
    </script>
</body>
</html>
