<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Intelligence - RCM Intelligence</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <link rel="icon" href="https://www.genspark.ai/api/files/s/kug10xIG" type="image/png">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Helvetica Neue', 'Proxima Nova', sans-serif;
            background: #FFFFFF;
            color: #111B2E;
            font-size: 15px;
            overflow: hidden;
        }

        /* Header with Movement Branding */
        .header {
            background: #FFFFFF;
            border-bottom: 2px solid #2B5BA6;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 2px 8px rgba(17, 27, 46, 0.08);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            height: 65px;
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            color: #111B2E;
            letter-spacing: -0.3px;
        }

        /* Navigation */
        .nav {
            display: flex;
            gap: 8px;
            margin-left: auto;
        }

        .nav a {
            color: #111B2E;
            text-decoration: none;
            padding: 8px 16px;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .nav a:hover {
            background: #FEF2F2;
            border-color: #2B5BA6;
            color: #2B5BA6;
        }

        .nav a.active {
            background: #2B5BA6;
            border-color: #2B5BA6;
            color: #FFFFFF;
        }

        .company-badge {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 700;
            color: #2B5BA6;
        }

        /* Main Container */
        .main-container {
            display: flex;
            position: fixed;
            top: 65px;
            left: 0;
            right: 0;
            bottom: 0;
        }

        /* Left Chat Panel - ALWAYS VISIBLE, FIXED */
        #chat-panel {
            width: 30%;
            min-width: 350px;
            max-width: 450px;
            background: #FFFFFF;
            border-right: 1px solid #E5E7EB;
            box-shadow: 2px 0 8px rgba(17, 27, 46, 0.05);
            display: flex;
            flex-direction: column;
            position: fixed;
            left: 0;
            top: 65px;
            bottom: 0;
            z-index: 100;
            overflow: hidden;
        }

        .chatbot-header {
            padding: 20px;
            border-bottom: 1px solid #E5E7EB;
            background: #FAFBFC;
        }

        .chatbot-header h2 {
            font-size: 18px;
            color: #2B5BA6;
            margin-bottom: 6px;
            font-weight: 700;
        }

        .chatbot-header p {
            font-size: 13px;
            color: #6B7280;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            background: #FFFFFF;
        }

        .message {
            padding: 12px 16px;
            border-radius: 10px;
            max-width: 90%;
            animation: fadeIn 0.3s ease;
            font-size: 14px;
            line-height: 1.6;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            align-self: flex-end;
            color: #111B2E;
        }

        .message.ai {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            align-self: flex-start;
            color: #111B2E;
        }

        .message.ai strong {
            color: #2B5BA6;
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .message.ai ul {
            margin: 8px 0 0 20px;
            font-size: 13px;
        }

        .message.ai .financial-impact {
            margin-top: 8px;
            padding: 8px 12px;
            background: #FEF3C7;
            border-left: 3px solid #F59E0B;
            border-radius: 4px;
            font-weight: 600;
            color: #92400E;
        }

        .sample-prompts {
            padding: 12px 20px;
            border-top: 1px solid #E5E7EB;
            background: #FAFBFC;
        }

        .sample-prompts-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .sample-prompts-header p {
            font-size: 12px;
            color: #6B7280;
            margin: 0;
            font-weight: 600;
        }

        .collapse-btn {
            background: transparent;
            border: none;
            color: #6B7280;
            cursor: pointer;
            font-size: 18px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s ease;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .collapse-btn:hover {
            background: #E5E7EB;
            color: #2B5BA6;
        }

        .prompt-buttons.collapsed {
            display: none;
        }

        .prompt-buttons {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .prompt-btn {
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            color: #111B2E;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            text-align: left;
            transition: all 0.2s ease;
            font-weight: 500;
        }

        .prompt-btn:hover {
            background: #FEF2F2;
            border-color: #2B5BA6;
            color: #2B5BA6;
        }

        .chat-input-area {
            padding: 16px 20px;
            border-top: 1px solid #E5E7EB;
            background: #FAFBFC;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            background: #FFFFFF;
            border: 1px solid #D1D5DB;
            color: #111B2E;
            padding: 10px 14px;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
            font-family: 'Inter', sans-serif;
        }

        .chat-input::placeholder {
            color: #9CA3AF;
        }

        .chat-input:focus {
            border-color: #2B5BA6;
            box-shadow: 0 0 0 3px rgba(43, 91, 166, 0.1);
        }

        .send-btn {
            background: #2B5BA6;
            border: none;
            color: #FFFFFF;
            padding: 10px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .send-btn:hover {
            background: #1E4A8C;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(43, 91, 166, 0.3);
        }

        /* Right Tree Graph Area */
        #tree-container {
            margin-left: 30%;
            min-width: 350px;
            width: 70%;
            background: #FAFBFC;
            display: flex;
            flex-direction: column;
            position: fixed;
            right: 0;
            top: 65px;
            bottom: 0;
        }

        .toolbar {
            background: #FFFFFF;
            border-bottom: 1px solid #E5E7EB;
            padding: 12px 20px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 1px 3px rgba(17, 27, 46, 0.05);
        }

        .toolbar-label {
            color: #6B7280;
            font-size: 13px;
            font-weight: 700;
            margin-right: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .control-btn {
            background: #FFFFFF;
            border: 1px solid #D1D5DB;
            color: #111B2E;
            padding: 7px 14px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .control-btn:hover {
            background: #FEF2F2;
            border-color: #2B5BA6;
            color: #2B5BA6;
        }

        .control-btn.primary {
            background: #2B5BA6;
            border-color: #2B5BA6;
            color: #FFFFFF;
        }

        .control-btn.primary:hover {
            background: #1E4A8C;
        }

        #tree-scroll-wrapper {
            flex: 1;
            overflow: auto;
            background: #FAFBFC;
            border: 3px solid #2B5BA6;  /* Red border to make container visible */
            position: relative;
        }

        #tree-scroll-wrapper::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        #tree-scroll-wrapper::-webkit-scrollbar-track {
            background: #F3F4F6;
        }

        #tree-scroll-wrapper::-webkit-scrollbar-thumb {
            background: #2B5BA6;
            border-radius: 6px;
            border: 2px solid #F3F4F6;
        }

        #tree-scroll-wrapper::-webkit-scrollbar-thumb:hover {
            background: #1E4A8C;
        }

        #tree-graph {
            min-width: 100%;
            min-height: 100%;
        }

        /* KPI Node Styles */
        .node circle {
            cursor: pointer;
            stroke-width: 2.5px;
            transition: all 0.3s ease;
            fill: #E0E7FF;  /* Default fill - light blue */
            stroke: #3B82F6;  /* Default stroke - blue */
        }
        
        /* Visual indicator for expandable nodes */
        .node.has-children circle {
            stroke-width: 3px;
        }
        
        .node.has-children:hover circle {
            stroke-width: 4px;
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.6));
        }

        .node.rag-red circle {
            fill: #FEF2F2;
            stroke: #2B5BA6;
            filter: drop-shadow(0 0 6px rgba(43, 91, 166, 0.4));
        }

        .node.rag-amber circle {
            fill: #FEF3C7;
            stroke: #F59E0B;
            filter: drop-shadow(0 0 6px rgba(245, 158, 11, 0.4));
        }

        .node.rag-green circle {
            fill: #ECFDF5;
            stroke: #10B981;
            filter: drop-shadow(0 0 6px rgba(16, 185, 129, 0.4));
        }

        .node:hover circle {
            transform: scale(1.15);
            filter: drop-shadow(0 0 12px currentColor);
        }

        .node text {
            fill: #111B2E;
            font-size: 13px;
            font-weight: 600;
            font-family: 'Inter', sans-serif;
        }

        .node .node-value {
            fill: #2B5BA6;
            font-size: 13px;
            font-weight: 700;
        }

        .node .node-trend {
            font-size: 11px;
            fill: #6B7280;
        }

        .link {
            fill: none;
            stroke: #9CA3AF;  /* More visible gray */
            stroke-width: 2px;
            opacity: 0.6;
        }

        /* Info Panel */
        .info-panel {
            position: fixed;
            right: 30px;
            top: 50%;
            transform: translateY(-50%);
            width: 400px;
            max-height: 85vh;
            background: #FFFFFF;
            border: 2px solid #2B5BA6;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(17, 27, 46, 0.15);
            display: none;
            z-index: 1000;
            overflow-y: auto;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-50%) translateX(20px); }
            to { opacity: 1; transform: translateY(-50%) translateX(0); }
        }

        .info-panel.visible {
            display: block;
        }

        .info-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #FEF2F2;
        }

        .info-panel-header h3 {
            color: #2B5BA6;
            font-size: 20px;
            font-weight: 700;
        }

        .close-btn {
            background: none;
            border: none;
            color: #9CA3AF;
            font-size: 28px;
            cursor: pointer;
            transition: color 0.2s ease;
            line-height: 1;
        }

        .close-btn:hover {
            color: #2B5BA6;
        }

        .info-row {
            margin-bottom: 16px;
        }

        .info-label {
            color: #6B7280;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 4px;
            font-weight: 700;
        }

        .info-value {
            color: #111B2E;
            font-size: 16px;
            font-weight: 600;
        }

        .info-value.large {
            font-size: 36px;
            color: #2B5BA6;
            font-weight: 700;
        }

        .rag-badge {
            display: inline-block;
            padding: 6px 14px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .rag-badge.red {
            background: #FEF2F2;
            color: #2B5BA6;
            border: 2px solid #2B5BA6;
        }

        .rag-badge.amber {
            background: #FEF3C7;
            color: #92400E;
            border: 2px solid #F59E0B;
        }

        .rag-badge.green {
            background: #ECFDF5;
            color: #047857;
            border: 2px solid #10B981;
        }

        .ai-analysis {
            background: #F9FAFB;
            border-left: 4px solid #2B5BA6;
            padding: 16px;
            border-radius: 8px;
            margin-top: 20px;
        }

        .ai-analysis h4 {
            color: #2B5BA6;
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .ai-analysis p {
            color: #111B2E;
            font-size: 14px;
            line-height: 1.7;
        }

        .recommended-actions {
            margin-top: 20px;
        }

        .recommended-actions h4 {
            color: #2B5BA6;
            font-size: 14px;
            margin-bottom: 12px;
            font-weight: 700;
        }

        .action-item {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-left: 3px solid #2B5BA6;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            color: #111B2E;
            font-size: 13px;
            line-height: 1.6;
        }

        .financial-impact-box {
            background: #FEF3C7;
            border: 2px solid #F59E0B;
            padding: 16px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: center;
        }

        .financial-impact-box .label {
            color: #92400E;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .financial-impact-box .value {
            color: #92400E;
            font-size: 28px;
            font-weight: 700;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            padding: 12px 16px;
            background: #FFFFFF;
            border: 2px solid #2B5BA6;
            border-radius: 8px;
            color: #111B2E;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(17, 27, 46, 0.15);
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip .tooltip-title {
            color: #2B5BA6;
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .tooltip .tooltip-row {
            margin: 4px 0;
            font-size: 12px;
        }

        .tooltip .tooltip-label {
            color: #6B7280;
            font-weight: 600;
        }

        /* Scrollbar Styling */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #F3F4F6;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #2B5BA6;
        }

        .info-panel::-webkit-scrollbar {
            width: 6px;
        }

        .info-panel::-webkit-scrollbar-track {
            background: #F3F4F6;
        }

        .info-panel::-webkit-scrollbar-thumb {
            background: #D1D5DB;
            border-radius: 3px;
        }

        .info-panel::-webkit-scrollbar-thumb:hover {
            background: #2B5BA6;
        }

        /* v6.0 - 5-Layer Decision Intelligence Card Styles */
        .kpi-layer-section {
            background: #FFFFFF;
            border: 1px solid rgba(17, 27, 46, 0.1);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .kpi-layer-section h4 {
            font-size: 16px;
            font-weight: 700;
            color: #111B2E;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .layer-icon {
            font-size: 18px;
        }

        .trend-text, .forecast-text {
            font-size: 14px;
            color: #374151;
            line-height: 1.6;
            margin-top: 8px;
            padding: 8px 0;
        }

        .sparkline-container, .forecast-chart-container {
            height: 60px;
            margin: 12px 0;
            position: relative;
        }

        .forecast-values {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 12px;
        }

        .forecast-value-box {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            padding: 12px;
            border-radius: 6px;
            text-align: center;
        }

        .forecast-value-box .label {
            font-size: 11px;
            font-weight: 600;
            color: #6B7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .forecast-value-box .value {
            font-size: 20px;
            font-weight: 700;
            color: #2B5BA6;
        }

        .rca-section {
            background: #F9FAFB;
            border: 1px solid rgba(17, 27, 46, 0.1);
            padding: 16px;
            border-radius: 8px;
            margin-top: 16px;
        }

        .rca-section h4 {
            font-size: 16px;
            font-weight: 700;
            color: #111B2E;
            margin-bottom: 12px;
        }

        .recommendation-section {
            background: linear-gradient(135deg, #FEF2F2 0%, #FFFFFF 100%);
            border: 2px solid #2B5BA6;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
        }

        .recommendation-section h4 {
            font-size: 16px;
            font-weight: 700;
            color: #2B5BA6;
            margin-bottom: 12px;
        }

        .layer-divider {
            height: 1px;
            background: linear-gradient(90deg, transparent 0%, #E5E7EB 50%, transparent 100%);
            margin: 20px 0;
        }

        .trend-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
            margin-top: 8px;
        }

        .trend-indicator.positive {
            background: #ECFDF5;
            color: #059669;
        }

        .trend-indicator.negative {
            background: #FEF2F2;
            color: #2B5BA6;
        }

        .trend-indicator.neutral {
            background: #F3F4F6;
            color: #6B7280;
        }

        /* Dependency Network Graph Styles */
        .dependency-graph-container {
            height: 300px;
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 8px;
            margin: 12px 0;
            position: relative;
            overflow: hidden;
        }

        .dependency-graph-container svg {
            width: 100%;
            height: 100%;
        }

        .dependency-legend {
            display: flex;
            gap: 16px;
            margin-top: 12px;
            padding: 8px 0;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            color: #6B7280;
            font-weight: 500;
        }

        .legend-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid #FFFFFF;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* Neo4j-style node and link styling */
        .dep-node {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dep-node:hover {
            filter: brightness(1.2);
        }

        .dep-node-circle {
            stroke: #FFFFFF;
            stroke-width: 3px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }

        .dep-node-text {
            font-size: 11px;
            font-weight: 600;
            fill: #111B2E;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.8);
        }

        .dep-link {
            stroke: #94A3B8;
            stroke-width: 2px;
            opacity: 0.6;
            fill: none;
        }

        .dep-link-arrow {
            fill: #94A3B8;
            opacity: 0.6;
        }

        .dep-link.highlighted {
            stroke: #2B5BA6;
            stroke-width: 3px;
            opacity: 1;
        }

        .dep-link-arrow.highlighted {
            fill: #2B5BA6;
            opacity: 1;
        }

        /* People & Accountability Styles */
        .accountability-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .accountability-section {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            padding: 12px;
        }

        .accountability-section h5 {
            font-size: 13px;
            font-weight: 700;
            color: #111B2E;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .person-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: #FFFFFF;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }

        .person-card:hover {
            border-color: #2B5BA6;
            box-shadow: 0 2px 4px rgba(43, 91, 166, 0.1);
        }

        .person-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 14px;
            color: #FFFFFF;
            flex-shrink: 0;
        }

        .person-info {
            flex: 1;
            min-width: 0;
        }

        .person-name {
            font-size: 13px;
            font-weight: 600;
            color: #111B2E;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .person-department {
            font-size: 11px;
            color: #6B7280;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .person-contribution {
            font-size: 11px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 4px;
            white-space: nowrap;
        }

        .person-contribution.positive {
            background: #ECFDF5;
            color: #059669;
        }

        .person-contribution.negative {
            background: #FEF2F2;
            color: #2B5BA6;
        }

        /* Contributing Factors Styles */
        .factors-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-top: 12px;
        }

        .factors-section {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 6px;
            padding: 12px;
        }

        .factors-section h5 {
            font-size: 13px;
            font-weight: 700;
            color: #111B2E;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .factor-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 8px;
            background: #FFFFFF;
            border-left: 3px solid #60A5FA;
            border-radius: 4px;
            margin-bottom: 8px;
            font-size: 12px;
            color: #374151;
            line-height: 1.5;
        }

        .factor-item.external {
            border-left-color: #F59E0B;
        }

        .factor-item::before {
            content: '‚Ä¢';
            color: #60A5FA;
            font-weight: 700;
            font-size: 16px;
            flex-shrink: 0;
        }

        .factor-item.external::before {
            color: #F59E0B;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="logo-container">
            <h1>RCM Intelligence</h1>
        </div>
        <div class="nav">
            <a href="index.html" class="active">Executive Advisor</a>
            <a href="control-center.html">KPI Control Center</a>
            <a href="command-center.html">Command Center</a>
            <a href="people-graph.html">People Graph</a>
            <a href="automation-hub.html">ü§ñ Automation Hub</a>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Left Chat Panel - ALWAYS VISIBLE, FIXED -->
        <div id="chat-panel">
            <div class="chatbot-header">
                <h2>ü§ñ AI Executive Advisor</h2>
                <p>Real-time KPI insights and recommendations</p>
            </div>

            <div class="chat-messages" id="chatMessages">
                <div class="message ai">
                    <strong>Welcome to RCM Intelligence! üè•</strong>
                    I'm your AI Executive Advisor specialized in Healthcare Revenue Cycle Management. I have real-time access to all 101 KPIs across your organization. Ask me about specific metrics, trends, root causes, predictions, or get personalized recommendations!
                </div>
            </div>

            <div class="sample-prompts">
                <div class="sample-prompts-header">
                    <p>Quick Questions:</p>
                    <button class="collapse-btn" onclick="togglePrompts()" id="collapseBtn" title="Collapse/Expand Quick Questions">
                        ‚ñº
                    </button>
                </div>
                <div class="prompt-buttons" id="promptButtons">
                    <button class="prompt-btn" onclick="askQuestion('What is our current collection efficiency status?')">
                        üí∞ Collection Efficiency Status
                    </button>
                    <button class="prompt-btn" onclick="askQuestion('Show me DSO performance and trends')">
                        üìä DSO Performance & Trends
                    </button>
                    <button class="prompt-btn" onclick="askQuestion('Analyze denial rate issues')">
                        ‚ö†Ô∏è Denial Rate Analysis
                    </button>
                    <button class="prompt-btn" onclick="askQuestion('What are our top 5 at-risk KPIs?')">
                        üö® Top 5 At-Risk KPIs
                    </button>
                    <button class="prompt-btn" onclick="askQuestion('Show me predictive insights for revenue')">
                        üîÆ Revenue Predictions
                    </button>
                    <button class="prompt-btn" onclick="askQuestion('Who is responsible for AR management?')">
                        üë• AR Management Team
                    </button>
                    <button class="prompt-btn" onclick="askQuestion('What dependencies affect cash collection?')">
                        üîó Cash Collection Dependencies
                    </button>
                    <button class="prompt-btn" onclick="askQuestion('Recommend actions for bad debt reduction')">
                        üí° Bad Debt Recommendations
                    </button>
                </div>
            </div>

            <div class="chat-input-area">
                <div class="chat-input-wrapper">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Ask me anything..." 
                           onkeypress="if(event.key==='Enter') sendMessage()">
                    <button class="send-btn" onclick="sendMessage()">Send</button>
                </div>
            </div>
        </div>

        <!-- Right Tree Graph Area -->
        <div id="tree-container">
            <div class="toolbar">
                <span class="toolbar-label">Controls:</span>
                <button class="control-btn primary" onclick="expandAll()">Expand All</button>
                <button class="control-btn" onclick="collapseAll()">Collapse All</button>
                <button class="control-btn" onclick="zoomIn()">Zoom In</button>
                <button class="control-btn" onclick="zoomOut()">Zoom Out</button>
                <button class="control-btn" onclick="centerGraph()">Center Graph</button>
                <button class="control-btn" onclick="refreshData()">Refresh Data</button>
                <span style="margin-left: 20px; font-size: 12px; color: #6B7280;">
                    üí° <strong>Tip:</strong> Click to expand/collapse | Shift+Click for details
                </span>
            </div>
            <div id="tree-scroll-wrapper">
                <div id="tree-graph" style="background: #FAFBFC; min-height: 100%; position: relative;">
                    <!-- D3 SVG will be inserted here -->
                    <div style="position: absolute; top: 10px; left: 10px; background: rgba(255,255,255,0.9); padding: 10px; border: 2px solid #2B5BA6; border-radius: 4px; z-index: 1000; font-size: 12px;">
                        <strong>üå≥ Tree Status:</strong><br>
                        <span id="tree-debug-info">Initializing...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Info Panel -->
    <div class="info-panel" id="infoPanel">
        <div class="info-panel-header">
            <h3 id="infoPanelTitle">KPI Details</h3>
            <button class="close-btn" onclick="closeInfoPanel()">√ó</button>
        </div>
        <div id="infoPanelContent"></div>
    </div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // Persistent Chat Store
        window.ChatStore = window.ChatStore || {
            messages: [],
            addMessage(type, content) {
                this.messages.push({ type, content, timestamp: Date.now() });
                localStorage.setItem('ChatStore', JSON.stringify(this.messages));
            },
            loadMessages() {
                const stored = localStorage.getItem('ChatStore');
                if (stored) {
                    this.messages = JSON.parse(stored);
                    return this.messages;
                }
                return [];
            },
            clear() {
                this.messages = [];
                localStorage.removeItem('ChatStore');
            }
        };

        // Global KPIStore for cross-page synchronization
        window.KPIStore = window.KPIStore || {
            values: {},
            baselineValues: {},
            listeners: [],
            
            subscribe(callback) {
                this.listeners.push(callback);
            },
            
            notify(kpiId, newValue) {
                this.values[kpiId] = newValue;
                this.listeners.forEach(fn => fn(kpiId, newValue));
                
                // Save to localStorage
                localStorage.setItem('KPIStore', JSON.stringify({
                    values: this.values,
                    baselineValues: this.baselineValues,
                    selectedKPI: JSON.parse(localStorage.getItem('KPIStore') || '{}').selectedKPI
                }));
                
                // Recalculate dependent KPIs
                this.recalculateDependencies(kpiId, newValue);
            },
            
            recalculateDependencies(changedKpiId, newValue) {
                const baseline = this.baselineValues[changedKpiId] || newValue;
                const delta = newValue - baseline;
                
                // Define KPI relationships
                const relationships = {
                    'automation_rate': {
                        'dso': { factor: -0.3 },
                        'ncr': { factor: 0.08 },
                        'cycle_time': { factor: -0.15 }
                    },
                    'touchless_pct': {
                        'dso': { factor: -0.2 },
                        'ncr': { factor: 0.05 },
                        'cycle_time': { factor: -0.1 }
                    },
                    'api_error_rate': {
                        'dso': { factor: 0.5 },
                        'ncr': { factor: -0.3 }
                    },
                    'data_quality_index': {
                        'critical_defect': { factor: -0.02 }
                    }
                };
                
                if (relationships[changedKpiId]) {
                    Object.keys(relationships[changedKpiId]).forEach(dependentId => {
                        const impact = relationships[changedKpiId][dependentId];
                        const dependentBaseline = this.baselineValues[dependentId];
                        if (dependentBaseline !== undefined) {
                            const newDependentValue = dependentBaseline + (delta * impact.factor);
                            this.values[dependentId] = newDependentValue;
                            updateNodeValue(dependentId, newDependentValue);
                        }
                    });
                }
            },
            
            getValue(kpiId) {
                return this.values[kpiId] || this.baselineValues[kpiId];
            },
            
            setBaseline(kpiId, value) {
                this.baselineValues[kpiId] = value;
                if (!this.values[kpiId]) {
                    this.values[kpiId] = value;
                }
            }
        };

        // Initialize from localStorage
        const storedData = JSON.parse(localStorage.getItem('KPIStore') || '{}');
        if (storedData.values) {
            window.KPIStore.values = storedData.values;
        }
        if (storedData.baselineValues) {
            window.KPIStore.baselineValues = storedData.baselineValues;
        }

        let kpiData = null;
        let treeData = null;
        let svg = null;
        let g = null;
        let root = null;
        let treeLayout = null;
        let zoom = null;
        let i = 0;

        // Load KPI data with cache busting
        async function loadKPIData() {
            try {
                // Add cache buster to force reload
                const cacheBuster = '?v=' + new Date().getTime();
                console.log('üîÑ Loading KPI data with cache buster...');
                
                const response = await fetch('kpi_map.json' + cacheBuster);
                kpiData = await response.json();
                
                // Verify we have the correct data
                console.log('‚úÖ KPI Data Version:', kpiData.version);
                console.log('‚úÖ Total Nodes:', kpiData.total_nodes);
                console.log('‚úÖ Root Name:', kpiData.tree.name);
                console.log('‚úÖ First Category:', kpiData.tree.children[0].name);
                
                // Verify it's Healthcare RCM data
                if (kpiData.version.includes('healthcare-rcm') || kpiData.tree.name.includes('Revenue Cycle')) {
                    console.log('‚úÖ CORRECT DATA: Healthcare RCM KPIs loaded!');
                } else {
                    console.error('‚ùå WRONG DATA: Old Movement Mortgage data detected!');
                    alert('Warning: Old data loaded. Please clear your browser cache and refresh.');
                }
                
                // Initialize baseline values
                kpiData.nodes.forEach(kpi => {
                    const numValue = parseFloat(kpi.value.replace(/[^0-9.]/g, ''));
                    window.KPIStore.setBaseline(kpi.id, numValue);
                });
                
                // Load chat history
                loadChatHistory();
                
                initializeTreeGraph();
            } catch (error) {
                console.error('‚ùå Error loading KPI data:', error);
            }
        }

        // Load chat history
        function loadChatHistory() {
            const messages = window.ChatStore.loadMessages();
            if (messages.length > 0) {
                const container = document.getElementById('chatMessages');
                container.innerHTML = '';
                messages.forEach(msg => {
                    addChatMessage(msg.type, msg.content, false);
                });
            }
        }

        // Build tree structure
        function buildTreeStructure() {
            // Use the pre-built hierarchical tree from kpiData
            if (kpiData.tree) {
                console.log('Using pre-built hierarchical tree with', countTreeNodes(kpiData.tree), 'nodes');
                return kpiData.tree;
            }
            
            // Fallback: build from flat nodes if tree not available
            const hierarchy = kpiData.hierarchy;
            const nodes = kpiData.nodes;

            const root = {
                name: 'Movement Mortgage KPIs',
                type: 'root',
                children: []
            };

            const categories = {};
            nodes.forEach(kpi => {
                if (!categories[kpi.category]) {
                    categories[kpi.category] = [];
                }
                categories[kpi.category].push(kpi);
            });

            Object.keys(hierarchy).forEach(category => {
                const categoryNode = {
                    name: category,
                    type: 'category',
                    level: hierarchy[category].level,
                    children: []
                };

                if (categories[category]) {
                    categories[category].forEach(kpi => {
                        const currentValue = window.KPIStore.getValue(kpi.id);
                        categoryNode.children.push({
                            ...kpi,
                            name: kpi.name,
                            type: 'kpi',
                            displayValue: formatKPIValue(kpi.id, currentValue)
                        });
                    });
                }

                root.children.push(categoryNode);
            });

            return root;
        }
        
        // Count total nodes in tree
        function countTreeNodes(node) {
            let count = 1;
            if (node.children && node.children.length > 0) {
                node.children.forEach(child => {
                    count += countTreeNodes(child);
                });
            }
            return count;
        }

        // Format KPI value
        function formatKPIValue(kpiId, value) {
            const kpi = kpiData.nodes.find(k => k.id === kpiId);
            if (!kpi) return value;
            
            const originalValue = kpi.value;
            if (originalValue.includes('%')) {
                return value.toFixed(1) + '%';
            } else if (originalValue.includes('$')) {
                return '$' + value.toFixed(1) + 'M';
            } else if (originalValue.includes('days')) {
                return Math.round(value) + ' days';
            } else if (originalValue.includes('ms')) {
                return Math.round(value) + 'ms';
            } else if (originalValue.includes('bps')) {
                return Math.round(value) + ' bps';
            }
            return value.toString();
        }

        // Update node value dynamically
        function updateNodeValue(kpiId, newValue) {
            if (!svg) return;
            
            const allNodes = root.descendants();
            const node = allNodes.find(n => n.data.id === kpiId);
            
            if (node && node.data) {
                node.data.displayValue = formatKPIValue(kpiId, newValue);
                node.data.value = formatKPIValue(kpiId, newValue);
                
                // Update RAG status
                const kpi = kpiData.nodes.find(k => k.id === kpiId);
                if (kpi) {
                    const target = parseFloat(kpi.target.replace(/[^0-9.]/g, ''));
                    let ragStatus = 'green';
                    
                    const inverseMetrics = ['dso', 'cycle_time', 'api_error_rate', 'critical_defect'];
                    const isInverse = inverseMetrics.includes(kpiId);
                    
                    if (isInverse) {
                        if (newValue > target * 1.2) ragStatus = 'red';
                        else if (newValue > target) ragStatus = 'amber';
                    } else {
                        if (newValue < target * 0.8) ragStatus = 'red';
                        else if (newValue < target) ragStatus = 'amber';
                    }
                    
                    node.data.rag = ragStatus;
                }
                
                updateTree(root);
            }
        }

        // Initialize tree graph
        function initializeTreeGraph() {
            const container = document.getElementById('tree-scroll-wrapper');
            const width = container.offsetWidth;
            const height = container.offsetHeight;

            console.log('Tree container dimensions:', width, 'x', height);

            d3.select('#tree-graph').selectAll('*').remove();

            svg = d3.select('#tree-graph')
                .append('svg')
                .attr('width', width * 2)
                .attr('height', height * 2);

            console.log('SVG created with dimensions:', width * 2, 'x', height * 2);

            zoom = d3.zoom()
                .scaleExtent([0.5, 2])
                .on('zoom', (event) => {
                    g.attr('transform', event.transform);
                });

            svg.call(zoom);

            g = svg.append('g')
                .attr('transform', `translate(100, ${height / 2})`);

            console.log('Initial g transform:', `translate(100, ${height / 2})`);

            treeData = buildTreeStructure();
            root = d3.hierarchy(treeData);

            console.log('Root hierarchy created with', root.descendants().length, 'total nodes');

            root.descendants().forEach(d => {
                // Start with only first 2 levels expanded (Root + Main Categories)
                // This allows users to click and expand individual categories
                if (d.depth > 1) {
                    d._children = d.children;
                    d.children = null;
                }
            });

            const expandedNodes = root.descendants().filter(d => d.children !== null);
            console.log('Expanded nodes (depth <= 3):', expandedNodes.length);

            treeLayout = d3.tree()
                .size([height * 1.8, width * 1.5])
                .separation((a, b) => (a.parent == b.parent ? 1 : 1.2));

            updateTree(root);
            setTimeout(() => centerGraph(), 100);
        }

        // Update tree
        function updateTree(source) {
            const duration = 400;
            const treeData = treeLayout(root);
            const nodes = treeData.descendants();
            const links = treeData.links();

            console.log('updateTree called - rendering', nodes.length, 'nodes and', links.length, 'links');
            
            // Update debug info
            const debugInfo = document.getElementById('tree-debug-info');
            if (debugInfo) {
                debugInfo.innerHTML = `
                    ‚úÖ ${nodes.length} nodes rendered<br>
                    ‚úÖ ${links.length} links<br>
                    ‚úÖ Data loaded: ${kpiData.tree.name}<br>
                    <span style="color: #10B981;">‚óè Tree is rendering!</span>
                `;
            }

            nodes.forEach(d => {
                d.y = d.depth * 300;
            });

            const node = g.selectAll('g.node')
                .data(nodes, d => d.id || (d.id = ++i));

            const nodeEnter = node.enter().append('g')
                .attr('class', d => {
                    let classes = 'node';
                    if (d.data.rag) classes += ` rag-${d.data.rag}`;
                    if (d.children || d._children) classes += ' has-children';
                    return classes;
                })
                .attr('transform', d => `translate(${source.y0 || 0},${source.x0 || 0})`)
                .on('click', (event, d) => nodeClick(event, d))
                .on('mouseenter', (event, d) => showTooltip(event, d))
                .on('mouseleave', hideTooltip);

            console.log('Created', nodeEnter.size(), 'new node groups');

            nodeEnter.append('circle')
                .attr('r', d => {
                    // Size based on level instead of type
                    if (d.data.level === 0) return 14;  // Root
                    if (d.data.level === 1) return 12;  // L1 categories
                    if (d.data.level === 2) return 10;  // L2 main KPIs
                    return 8;  // L3-L6 sub-KPIs
                })
                .style('cursor', 'pointer');
            
            // Add expand/collapse indicator for nodes with children
            nodeEnter.append('text')
                .attr('class', 'expand-indicator')
                .attr('dy', '.35em')
                .attr('text-anchor', 'middle')
                .style('font-size', '10px')
                .style('font-weight', 'bold')
                .style('fill', '#111')
                .style('pointer-events', 'none')
                .text(d => {
                    if (d.children || d._children) {
                        return d.children ? '‚àí' : '+';  // Minus if expanded, plus if collapsed
                    }
                    return '';
                });

            nodeEnter.append('text')
                .attr('dy', '.35em')
                .attr('x', d => d.children || d._children ? -18 : 18)
                .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
                .text(d => {
                    const maxLength = 35;
                    return d.data.name.length > maxLength ? d.data.name.substring(0, maxLength) + '...' : d.data.name;
                });

            nodeEnter.append('text')
                .attr('class', 'node-value')
                .attr('dy', '1.7em')
                .attr('x', d => d.children || d._children ? -18 : 18)
                .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
                .text(d => d.data.displayValue || d.data.value || '');

            nodeEnter.append('text')
                .attr('class', 'node-trend')
                .attr('dy', '3em')
                .attr('x', d => d.children || d._children ? -18 : 18)
                .attr('text-anchor', d => d.children || d._children ? 'end' : 'start')
                .text(d => d.data.trend || '');

            const nodeUpdate = nodeEnter.merge(node);

            nodeUpdate.transition()
                .duration(duration)
                .attr('transform', d => `translate(${d.y},${d.x})`);

            nodeUpdate.select('circle')
                .attr('class', d => d.data.rag ? 'rag-' + d.data.rag : '');

            nodeUpdate.select('.node-value')
                .text(d => d.data.displayValue || d.data.value || '');
            
            // Update expand/collapse indicator
            nodeUpdate.select('.expand-indicator')
                .text(d => {
                    if (d.children || d._children) {
                        return d.children ? '‚àí' : '+';
                    }
                    return '';
                });

            const nodeExit = node.exit().transition()
                .duration(duration)
                .attr('transform', d => `translate(${source.y},${source.x})`)
                .remove();

            nodeExit.select('circle').attr('r', 0);
            nodeExit.select('text').style('fill-opacity', 0);

            const link = g.selectAll('path.link')
                .data(links, d => d.target.id);

            const linkEnter = link.enter().insert('path', 'g')
                .attr('class', 'link')
                .attr('d', d => {
                    const o = {x: source.x0 || 0, y: source.y0 || 0};
                    return diagonal(o, o);
                });

            const linkUpdate = linkEnter.merge(link);

            linkUpdate.transition()
                .duration(duration)
                .attr('d', d => diagonal(d.source, d.target));

            link.exit().transition()
                .duration(duration)
                .attr('d', d => {
                    const o = {x: source.x, y: source.y};
                    return diagonal(o, o);
                })
                .remove();

            nodes.forEach(d => {
                d.x0 = d.x;
                d.y0 = d.y;
            });
        }

        // Diagonal path
        function diagonal(s, d) {
            return `M ${s.y} ${s.x}
                    C ${(s.y + d.y) / 2} ${s.x},
                      ${(s.y + d.y) / 2} ${d.x},
                      ${d.y} ${d.x}`;
        }

        // Node click - handles both expansion and detail view
        function nodeClick(event, d) {
            // Check if Shift key is pressed for detail view
            const isShiftClick = event.shiftKey;
            
            if (isShiftClick) {
                // Shift+Click: Always show detail panel for any node
                console.log('Shift+Click - Opening KPI card for:', d.data.name);
                
                // Find the complete KPI data from the flat nodes array
                const fullKpiData = kpiData.nodes.find(node => node.id === d.data.id);
                
                if (fullKpiData) {
                    showInfoPanel(fullKpiData);
                } else {
                    // Fallback: use the tree node data
                    showInfoPanel(d.data);
                }
            } else {
                // Normal Click: Expand/collapse behavior
                const hasChildren = d.children || d._children;
                
                if (hasChildren) {
                    // Node has children - toggle expand/collapse
                    console.log('Normal click - Toggling node:', d.data.name, '- Currently', d.children ? 'expanded' : 'collapsed');
                    
                    if (d.children) {
                        // Currently expanded - collapse it
                        d._children = d.children;
                        d.children = null;
                    } else {
                        // Currently collapsed - expand it
                        d.children = d._children;
                        d._children = null;
                    }
                    updateTree(d);
                } else {
                    // Leaf node with normal click - also show detail panel
                    console.log('Leaf node clicked:', d.data.name);
                    
                    const fullKpiData = kpiData.nodes.find(node => node.id === d.data.id);
                    
                    if (fullKpiData) {
                        showInfoPanel(fullKpiData);
                    } else {
                        showInfoPanel(d.data);
                    }
                }
            }
        }

        // Generate People & Accountability section
        function generatePeopleAccountability(kpiId) {
            const peopleData = {
                'ncr': {
                    positive: [
                        { name: 'Sarah Martinez', department: 'Revenue Cycle', initials: 'SM', color: '#10B981' },
                        { name: 'David Chen', department: 'Collections', initials: 'DC', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Robert Wilson', department: 'Claims Processing', initials: 'RW', color: '#EF4444' }
                    ]
                },
                'dso': {
                    positive: [
                        { name: 'Jennifer Taylor', department: 'Payment Processing', initials: 'JT', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Michael Johnson', department: 'Accounts Receivable', initials: 'MJ', color: '#EF4444' },
                        { name: 'Lisa Anderson', department: 'Billing Operations', initials: 'LA', color: '#EF4444' }
                    ]
                },
                'op_margin': {
                    positive: [
                        { name: 'Amanda Roberts', department: 'Finance', initials: 'AR', color: '#10B981' },
                        { name: 'Christopher Lee', department: 'Cost Management', initials: 'CL', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Daniel Brown', department: 'Operations', initials: 'DB', color: '#EF4444' }
                    ]
                },
                'monthly_revenue': {
                    positive: [
                        { name: 'Emily Davis', department: 'Sales', initials: 'ED', color: '#10B981' },
                        { name: 'James Wilson', department: 'Business Development', initials: 'JW', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Patricia Moore', department: 'Marketing', initials: 'PM', color: '#EF4444' }
                    ]
                },
                'cycle_time': {
                    positive: [
                        { name: 'Thomas Garcia', department: 'Process Improvement', initials: 'TG', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Maria Rodriguez', department: 'Underwriting', initials: 'MR', color: '#EF4444' },
                        { name: 'Kevin Martinez', department: 'Document Verification', initials: 'KM', color: '#EF4444' }
                    ]
                },
                'touchless_pct': {
                    positive: [
                        { name: 'Susan Thompson', department: 'Automation Team', initials: 'ST', color: '#10B981' },
                        { name: 'Brian White', department: 'IT Development', initials: 'BW', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Nancy Harris', department: 'Manual Processing', initials: 'NH', color: '#EF4444' }
                    ]
                },
                'nps': {
                    positive: [
                        { name: 'Jessica Clark', department: 'Customer Success', initials: 'JC', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Mark Lewis', department: 'Customer Support', initials: 'ML', color: '#EF4444' }
                    ]
                },
                'csat': {
                    positive: [
                        { name: 'Laura Walker', department: 'Customer Experience', initials: 'LW', color: '#10B981' },
                        { name: 'Steven Hall', department: 'Service Quality', initials: 'SH', color: '#10B981' }
                    ],
                    negative: []
                },
                'uptime': {
                    positive: [
                        { name: 'Richard Allen', department: 'IT Operations', initials: 'RA', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Karen Young', department: 'Infrastructure', initials: 'KY', color: '#EF4444' }
                    ]
                },
                'automation_rate': {
                    positive: [
                        { name: 'Paul King', department: 'AI/ML Engineering', initials: 'PK', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Dorothy Wright', department: 'Legacy Systems', initials: 'DW', color: '#EF4444' }
                    ]
                },
                'data_quality_index': {
                    positive: [
                        { name: 'Ryan Scott', department: 'Data Governance', initials: 'RS', color: '#10B981' }
                    ],
                    negative: [
                        { name: 'Michelle Green', department: 'Data Entry', initials: 'MG', color: '#EF4444' }
                    ]
                }
            };

            const data = peopleData[kpiId] || { positive: [], negative: [] };

            let html = '<div class="accountability-grid">';
            
            // Positive Contributors
            html += '<div class="accountability-section">';
            html += '<h5><span style="color: #10B981;">‚úì</span> Positive Contributors</h5>';
            if (data.positive.length > 0) {
                data.positive.forEach(person => {
                    html += `
                        <div class="person-card">
                            <div class="person-avatar" style="background: ${person.color};">
                                ${person.initials}
                            </div>
                            <div class="person-info">
                                <div class="person-name">${person.name}</div>
                                <div class="person-department">${person.department}</div>
                            </div>
                            <div class="person-contribution positive">+</div>
                        </div>
                    `;
                });
            } else {
                html += '<div style="color: #9CA3AF; font-size: 12px; padding: 8px;">No data available</div>';
            }
            html += '</div>';

            // Negative Contributors
            html += '<div class="accountability-section">';
            html += '<h5><span style="color: #EF4444;">‚ö†</span> Needs Improvement</h5>';
            if (data.negative.length > 0) {
                data.negative.forEach(person => {
                    html += `
                        <div class="person-card">
                            <div class="person-avatar" style="background: ${person.color};">
                                ${person.initials}
                            </div>
                            <div class="person-info">
                                <div class="person-name">${person.name}</div>
                                <div class="person-department">${person.department}</div>
                            </div>
                            <div class="person-contribution negative">‚àí</div>
                        </div>
                    `;
                });
            } else {
                html += '<div style="color: #9CA3AF; font-size: 12px; padding: 8px;">No data available</div>';
            }
            html += '</div>';

            html += '</div>';
            return html;
        }

        // Generate Contributing Factors section
        function generateContributingFactors(kpiId) {
            const factorsData = {
                'ncr': {
                    internal: [
                        'Automated claim scrubbing system deployment',
                        'Training program for denial management team',
                        'Integration of real-time validation rules',
                        'Enhanced QA processes in billing workflow'
                    ],
                    external: [
                        'Insurance carrier policy changes',
                        'Regulatory updates affecting claim processing',
                        'Market-wide increase in claim scrutiny',
                        'Third-party payer system upgrades'
                    ]
                },
                'dso': {
                    internal: [
                        'Payment automation system efficiency',
                        'Invoice accuracy and timeliness',
                        'Collection team performance',
                        'Billing process optimization'
                    ],
                    external: [
                        'Economic conditions affecting payment timing',
                        'Customer payment behavior trends',
                        'Banking system processing delays',
                        'Industry standard payment terms'
                    ]
                },
                'op_margin': {
                    internal: [
                        'Cost control initiatives effectiveness',
                        'Operational efficiency improvements',
                        'Technology investment ROI',
                        'Workforce productivity optimization'
                    ],
                    external: [
                        'Market interest rate fluctuations',
                        'Competitive pricing pressures',
                        'Industry-wide margin compression',
                        'Regulatory compliance costs'
                    ]
                },
                'monthly_revenue': {
                    internal: [
                        'Sales team performance and targets',
                        'Marketing campaign effectiveness',
                        'Product mix and pricing strategy',
                        'Customer retention programs'
                    ],
                    external: [
                        'Housing market conditions',
                        'Interest rate environment',
                        'Economic growth indicators',
                        'Competitor market share changes'
                    ]
                },
                'cycle_time': {
                    internal: [
                        'Process automation coverage',
                        'Staff capacity and workload balance',
                        'System performance and uptime',
                        'Document management efficiency'
                    ],
                    external: [
                        'Third-party verification turnaround times',
                        'Borrower document submission delays',
                        'Appraisal processing timelines',
                        'Title company response times'
                    ]
                },
                'touchless_pct': {
                    internal: [
                        'AI/ML model accuracy improvements',
                        'Automation workflow coverage expansion',
                        'Exception handling optimization',
                        'Quality control automation deployment'
                    ],
                    external: [
                        'Document standardization in industry',
                        'Data quality from external sources',
                        'Regulatory requirements for manual review',
                        'Technology vendor capabilities'
                    ]
                },
                'nps': {
                    internal: [
                        'Customer communication quality',
                        'Digital experience enhancements',
                        'Process transparency improvements',
                        'Support team responsiveness'
                    ],
                    external: [
                        'Market expectation changes',
                        'Competitor service benchmarks',
                        'Economic stress on customers',
                        'Industry reputation trends'
                    ]
                },
                'csat': {
                    internal: [
                        'Service delivery excellence',
                        'Employee training and engagement',
                        'Technology platform usability',
                        'Proactive communication initiatives'
                    ],
                    external: [
                        'Customer expectations evolution',
                        'Industry service standards',
                        'Market sentiment and confidence',
                        'External review platform impact'
                    ]
                },
                'uptime': {
                    internal: [
                        'Infrastructure redundancy implementation',
                        'Maintenance window optimization',
                        'Monitoring and alerting effectiveness',
                        'Incident response procedures'
                    ],
                    external: [
                        'Cloud provider SLA performance',
                        'Network connectivity issues',
                        'DDoS attack frequency',
                        'Third-party service dependencies'
                    ]
                },
                'automation_rate': {
                    internal: [
                        'AI model deployment velocity',
                        'Workflow automation coverage',
                        'Change management effectiveness',
                        'Technology stack modernization'
                    ],
                    external: [
                        'AI/ML technology maturity',
                        'Vendor solution availability',
                        'Industry automation benchmarks',
                        'Regulatory approval processes'
                    ]
                },
                'data_quality_index': {
                    internal: [
                        'Data governance framework maturity',
                        'Master data management practices',
                        'Data validation rule coverage',
                        'Data stewardship accountability'
                    ],
                    external: [
                        'Source system data quality',
                        'Third-party data accuracy',
                        'Industry data standards adoption',
                        'Integration complexity with partners'
                    ]
                }
            };

            const data = factorsData[kpiId] || { internal: [], external: [] };

            let html = '<div class="factors-grid">';
            
            // Internal Factors
            html += '<div class="factors-section">';
            html += '<h5><span style="color: #60A5FA;">üè¢</span> Internal Factors</h5>';
            if (data.internal.length > 0) {
                data.internal.forEach(factor => {
                    html += `<div class="factor-item">${factor}</div>`;
                });
            } else {
                html += '<div style="color: #9CA3AF; font-size: 12px; padding: 8px;">No data available</div>';
            }
            html += '</div>';

            // External Factors
            html += '<div class="factors-section">';
            html += '<h5><span style="color: #F59E0B;">üåç</span> External Factors</h5>';
            if (data.external.length > 0) {
                data.external.forEach(factor => {
                    html += `<div class="factor-item external">${factor}</div>`;
                });
            } else {
                html += '<div style="color: #9CA3AF; font-size: 12px; padding: 8px;">No data available</div>';
            }
            html += '</div>';

            html += '</div>';
            return html;
        }

        // Show info panel - Enhanced with 10-Layer Intelligence
        function showInfoPanel(kpi) {
            const panel = document.getElementById('infoPanel');
            const title = document.getElementById('infoPanelTitle');
            const content = document.getElementById('infoPanelContent');

            title.textContent = kpi.name;

            const currentValue = window.KPIStore.getValue(kpi.id);
            const displayValue = formatKPIValue(kpi.id, currentValue);

            // Build complete 10-layer intelligence card
            let html = `
                <!-- Layer 1: KPI Summary -->
                <div class="info-row">
                    <div class="info-label">Current Value</div>
                    <div class="info-value large" id="panel-current-value">${displayValue}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Target</div>
                    <div class="info-value">${kpi.target}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Status</div>
                    <div><span class="rag-badge ${kpi.rag}">${kpi.rag.toUpperCase()}</span></div>
                </div>
                <div class="info-row">
                    <div class="info-label">Category</div>
                    <div class="info-value">${kpi.category}</div>
                </div>

                <div class="layer-divider"></div>

                <!-- Layer 2: Context & Description -->
                <div class="kpi-layer-section">
                    <h4><span class="layer-icon">üìã</span> Context & Business Impact</h4>
                    <p style="color: #6B7280; line-height: 1.6;">${kpi.context || kpi.description}</p>
                </div>

                <div class="layer-divider"></div>

                <!-- Layer 3: Current State Analysis -->
                <div class="kpi-layer-section">
                    <h4><span class="layer-icon">üìä</span> Current State Analysis</h4>
                    <p style="color: #6B7280; line-height: 1.6;">${kpi.current_state}</p>
                    ${kpi.financial_impact ? `
                        <div class="financial-impact-box" style="margin-top: 12px; padding: 12px; background: #FEF3C7; border-left: 4px solid #F59E0B; border-radius: 4px;">
                            <div style="font-weight: 600; color: #92400E;">${kpi.financial_impact}</div>
                        </div>
                    ` : ''}
                </div>

                <div class="layer-divider"></div>

                <!-- Layer 4: ROOT CAUSE ANALYSIS (NEW!) -->
                ${kpi.root_causes && kpi.root_causes.length > 0 ? `
                    <div class="kpi-layer-section">
                        <h4><span class="layer-icon">üéØ</span> Root Cause Analysis</h4>
                        ${kpi.root_causes.map((rc, i) => `
                            <div style="background: ${rc.impact === 'High' ? '#FEE2E2' : rc.impact === 'Medium' ? '#FEF3C7' : '#ECFDF5'}; padding: 12px; border-radius: 8px; margin-bottom: 12px; border-left: 4px solid ${rc.impact === 'High' ? '#EF4444' : rc.impact === 'Medium' ? '#F59E0B' : '#10B981'};">
                                <div style="font-weight: 600; color: #111; margin-bottom: 6px;">
                                    Root Cause #${i + 1}: ${rc.cause}
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 12px; color: #6B7280;">
                                    <span><strong>Impact:</strong> ${rc.impact}</span>
                                    <span><strong>Confidence:</strong> ${rc.confidence}</span>
                                    <span><strong>Data Points:</strong> ${rc.data_points.toLocaleString()}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="layer-divider"></div>
                ` : ''}

                <!-- Layer 5: PREDICTIVE INSIGHTS (NEW!) -->
                ${kpi.predictive_insights ? `
                    <div class="kpi-layer-section">
                        <h4><span class="layer-icon">üîÆ</span> Predictive Insights (AI-Powered)</h4>
                        <div style="background: #F3F4F6; padding: 12px; border-radius: 8px; margin-bottom: 12px;">
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; font-size: 13px;">
                                <div>
                                    <div style="color: #6B7280;">Pattern</div>
                                    <div style="font-weight: 600; color: #111;">${kpi.predictive_insights.pattern}</div>
                                </div>
                                <div>
                                    <div style="color: #6B7280;">Confidence</div>
                                    <div style="font-weight: 600; color: #111;">${kpi.predictive_insights.confidence}%</div>
                                </div>
                                <div>
                                    <div style="color: #6B7280;">Timeframe</div>
                                    <div style="font-weight: 600; color: #111;">${kpi.predictive_insights.timeframe}</div>
                                </div>
                            </div>
                        </div>
                        <div style="margin-top: 12px;">
                            <strong style="display: block; margin-bottom: 8px; color: #374151;">Forecast Scenarios:</strong>
                            ${kpi.predictive_insights.scenarios.map(s => `
                                <div style="padding: 10px; border-left: 3px solid ${s.name.includes('Best') ? '#10B981' : s.name.includes('Worst') ? '#EF4444' : '#3B82F6'}; margin-bottom: 8px; background: #F9FAFB;">
                                    <div style="font-weight: 600; color: #111; margin-bottom: 4px;">
                                        ${s.name} <span style="color: #6B7280; font-weight: normal;">(${s.probability} probability)</span>
                                    </div>
                                    <div style="font-size: 13px; color: #6B7280;">${s.outcome}</div>
                                </div>
                            `).join('')}
                        </div>
                        ${kpi.predictive_insights.leading_indicators && kpi.predictive_insights.leading_indicators.length > 0 ? `
                            <div style="margin-top: 12px;">
                                <strong style="display: block; margin-bottom: 8px; color: #374151;">Leading Indicators:</strong>
                                <ul style="margin: 0; padding-left: 20px; color: #6B7280; font-size: 13px;">
                                    ${kpi.predictive_insights.leading_indicators.map(ind => `<li style="margin-bottom: 4px;">${ind}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        <div style="margin-top: 16px;">
                            <strong style="display: block; margin-bottom: 12px; color: #374151;">Predictive Forecast Chart:</strong>
                            <div style="height: 200px; background: #F9FAFB; border-radius: 8px; padding: 16px; border: 1px solid #E5E7EB;">
                                <canvas id="forecast-chart-${kpi.id}" style="width: 100%; height: 100%;"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="layer-divider"></div>
                ` : ''}

                <!-- Layer 6: TREND ANALYSIS (NEW!) -->
                ${kpi.trend_analysis ? `
                    <div class="kpi-layer-section">
                        <h4><span class="layer-icon">üìà</span> Trend Analysis</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 12px;">
                            <div style="background: #F3F4F6; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #6B7280;">Trend</div>
                                <div style="font-weight: 600; color: #111;">${kpi.trend_analysis.current_trend}</div>
                            </div>
                            <div style="background: #F3F4F6; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #6B7280;">Strength</div>
                                <div style="font-weight: 600; color: #111;">${kpi.trend_analysis.trend_strength}</div>
                            </div>
                            <div style="background: #F3F4F6; padding: 10px; border-radius: 6px;">
                                <div style="font-size: 11px; color: #6B7280;">Volatility</div>
                                <div style="font-weight: 600; color: #111;">${kpi.trend_analysis.volatility}</div>
                            </div>
                        </div>
                        ${kpi.trend_data && kpi.trend_data.length > 0 ? `
                            <div style="height: 120px; background: #F9FAFB; border-radius: 8px; padding: 12px;">
                                <canvas id="trend-sparkline-${kpi.id}" style="width: 100%; height: 100%;"></canvas>
                            </div>
                        ` : ''}
                        ${kpi.trend_analysis.key_insights && kpi.trend_analysis.key_insights.length > 0 ? `
                            <div style="margin-top: 12px;">
                                <strong style="display: block; margin-bottom: 8px; color: #374151;">Key Insights:</strong>
                                <ul style="margin: 0; padding-left: 20px; color: #6B7280; font-size: 13px;">
                                    ${kpi.trend_analysis.key_insights.map(insight => `<li style="margin-bottom: 4px;">${insight}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    <div class="layer-divider"></div>
                ` : ''}

                <!-- Layer 7: DEPENDENCIES -->
                ${kpi.dependencies ? `
                    <div class="kpi-layer-section">
                        <h4><span class="layer-icon">üîó</span> Dependencies</h4>
                        <div style="display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 16px;">
                            ${kpi.dependencies.upstream && kpi.dependencies.upstream.length > 0 ? `
                                <div>
                                    <strong style="color: #3B82F6;">‚Üë Upstream (What affects this):</strong>
                                    <div style="margin-top: 6px; padding: 8px; background: #EFF6FF; border-radius: 6px; font-size: 13px;">
                                        ${kpi.dependencies.upstream.join(', ')}
                                    </div>
                                </div>
                            ` : ''}
                            ${kpi.dependencies.downstream && kpi.dependencies.downstream.length > 0 ? `
                                <div>
                                    <strong style="color: #EF4444;">‚Üì Downstream (What this affects):</strong>
                                    <div style="margin-top: 6px; padding: 8px; background: #FEE2E2; border-radius: 6px; font-size: 13px;">
                                        ${kpi.dependencies.downstream.join(', ')}
                                    </div>
                                </div>
                            ` : ''}
                            ${kpi.dependencies.peer && kpi.dependencies.peer.length > 0 ? `
                                <div>
                                    <strong style="color: #10B981;">‚Üî Peer Metrics (Related):</strong>
                                    <div style="margin-top: 6px; padding: 8px; background: #ECFDF5; border-radius: 6px; font-size: 13px;">
                                        ${kpi.dependencies.peer.join(', ')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                        <div style="margin-top: 16px;">
                            <strong style="display: block; margin-bottom: 12px; color: #374151;">Neo4j-Style Dependency Network Graph:</strong>
                            <div class="dependency-graph-container" id="dependency-graph-${kpi.id}" style="height: 300px; background: #FAFBFC; border-radius: 8px; border: 1px solid #E5E7EB; position: relative;">
                                <!-- D3.js dependency graph will be rendered here -->
                            </div>
                            <div class="dependency-legend" style="display: flex; gap: 20px; justify-content: center; margin-top: 12px; font-size: 12px;">
                                <span class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                    <span class="legend-dot" style="width: 12px; height: 12px; border-radius: 50%; background: #10B981; display: inline-block;"></span>
                                    Current KPI
                                </span>
                                <span class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                    <span class="legend-dot" style="width: 12px; height: 12px; border-radius: 50%; background: #60A5FA; display: inline-block;"></span>
                                    Upstream (Causes)
                                </span>
                                <span class="legend-item" style="display: flex; align-items: center; gap: 6px;">
                                    <span class="legend-dot" style="width: 12px; height: 12px; border-radius: 50%; background: #F59E0B; display: inline-block;"></span>
                                    Downstream (Effects)
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="layer-divider"></div>
                ` : ''}

                <!-- Layer 8: PEOPLE & ACCOUNTABILITY (NEW!) -->
                ${kpi.people_accountable && kpi.people_accountable.length > 0 ? `
                    <div class="kpi-layer-section">
                        <h4><span class="layer-icon">üë•</span> People & Accountability</h4>
                        ${kpi.people_accountable.map(person => `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #F9FAFB; border-radius: 8px; margin-bottom: 8px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background: ${person.color}; color: white; display: flex; align-items: center; justify-content: center; font-weight: 700; flex-shrink: 0;">
                                    ${person.initials}
                                </div>
                                <div style="flex: 1;">
                                    <div style="font-weight: 600; color: #111;">${person.name}</div>
                                    <div style="font-size: 12px; color: #6B7280;">${person.title} ¬∑ ${person.department}</div>
                                    <div style="font-size: 11px; color: #9CA3AF;">${person.email}</div>
                                </div>
                                <div style="background: ${person.role === 'Primary Owner' ? '#2B5BA6' : '#3B82F6'}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                    ${person.role}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="layer-divider"></div>
                ` : ''}

                <!-- Layer 9: RECOMMENDED ACTIONS (ENHANCED!) -->
                ${kpi.recommended_actions && kpi.recommended_actions.length > 0 ? `
                    <div class="kpi-layer-section">
                        <h4><span class="layer-icon">‚ö°</span> Recommended Actions</h4>
                        ${kpi.recommended_actions.map((action, i) => {
                            const priorityColor = action.priority === 'Critical' ? '#EF4444' : action.priority === 'High' ? '#F59E0B' : action.priority === 'Medium' ? '#3B82F6' : '#10B981';
                            return `
                                <div style="border: 2px solid ${priorityColor}; border-radius: 8px; padding: 12px; margin-bottom: 12px; background: #FAFBFC;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                        <span style="font-weight: 700; color: #111;">Action #${i + 1}</span>
                                        <span style="background: ${priorityColor}; color: white; padding: 4px 10px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                            ${action.priority} PRIORITY
                                        </span>
                                    </div>
                                    <div style="font-weight: 600; color: #374151; margin-bottom: 8px;">${action.action}</div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 8px; font-size: 12px; margin-bottom: 8px;">
                                        <div><span style="color: #6B7280;">Timeline:</span> <strong>${action.timeline}</strong></div>
                                        <div><span style="color: #6B7280;">Owner:</span> <strong>${action.owner}</strong></div>
                                    </div>
                                    <div style="font-size: 13px; color: #6B7280; margin-bottom: 6px;">
                                        <strong style="color: #374151;">Expected Impact:</strong> ${action.expected_impact}
                                    </div>
                                    <div style="font-size: 12px; color: #6B7280;">
                                        <strong>Resources:</strong> ${action.resources_needed}
                                    </div>
                                    ${action.success_metrics && action.success_metrics.length > 0 ? `
                                        <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E5E7EB;">
                                            <strong style="font-size: 12px; color: #374151;">Success Metrics:</strong>
                                            <ul style="margin: 4px 0 0 0; padding-left: 20px; font-size: 12px; color: #6B7280;">
                                                ${action.success_metrics.map(m => `<li>${m}</li>`).join('')}
                                            </ul>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : ''}
            `;

            content.innerHTML = html;
            
            // Draw visualizations after DOM update
            setTimeout(() => {
                // Draw sparkline if trend data exists
                if (kpi.trend_data && kpi.trend_data.length > 0) {
                    drawTrendSparklineNew(kpi.id, kpi.trend_data);
                }
                
                // Draw predictive forecast chart if predictive insights exist
                if (kpi.predictive_insights && kpi.predictive_insights.scenarios) {
                    drawPredictiveForecastChart(kpi.id, kpi.predictive_insights, kpi.trend_data);
                }
                
                // Draw Neo4j-style dependency graph if dependencies exist
                if (kpi.dependencies && (kpi.dependencies.upstream || kpi.dependencies.downstream)) {
                    drawDependencyGraph(kpi.id, kpi.dependencies);
                }
            }, 100);

            panel.classList.add('visible');

            window.KPIStore.subscribe((changedKpiId, newValue) => {
                if (changedKpiId === kpi.id) {
                    const panelValue = document.getElementById('panel-current-value');
                    if (panelValue) {
                        panelValue.textContent = formatKPIValue(kpi.id, newValue);
                        panelValue.style.transform = 'scale(1.1)';
                        setTimeout(() => {
                            panelValue.style.transform = 'scale(1)';
                        }, 300);
                    }
                }
            });

            const store = JSON.parse(localStorage.getItem('KPIStore') || '{}');
            store.selectedKPI = kpi.id;
            localStorage.setItem('KPIStore', JSON.stringify(store));
        }

        // Helper function to draw trend sparkline for new data structure
        function drawTrendSparklineNew(kpiId, trendData) {
            const canvas = document.getElementById(`trend-sparkline-${kpiId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (window[`chart_${kpiId}`]) {
                window[`chart_${kpiId}`].destroy();
            }

            window[`chart_${kpiId}`] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: trendData.map(d => d.month),
                    datasets: [{
                        data: trendData.map(d => d.value),
                        borderColor: '#2B5BA6',
                        backgroundColor: 'rgba(43, 91, 166, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3,
                        pointBackgroundColor: '#2B5BA6'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                title: (items) => trendData[items[0].dataIndex].month,
                                label: (item) => `Value: ${item.parsed.y.toFixed(1)}`
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {color: '#E5E7EB'},
                            ticks: {font: {size: 10}, color: '#6B7280'}
                        },
                        x: {
                            grid: {display: false},
                            ticks: {font: {size: 9}, color: '#6B7280', maxRotation: 45}
                        }
                    }
                }
            });
        }

        // Helper function to draw predictive forecast chart with 3 scenarios
        function drawPredictiveForecastChart(kpiId, predictiveInsights, trendData) {
            const canvas = document.getElementById(`forecast-chart-${kpiId}`);
            if (!canvas) return;

            const ctx = canvas.getContext('2d');
            if (window[`forecast_chart_${kpiId}`]) {
                window[`forecast_chart_${kpiId}`].destroy();
            }

            // Extract current value from latest trend data or use a baseline
            const currentValue = trendData && trendData.length > 0 ? 
                trendData[trendData.length - 1].value : 100;

            // Extract scenario values from predictive insights
            // Parse percentage improvements from scenario outcomes
            const bestCaseMatch = predictiveInsights.scenarios.find(s => s.name.includes('Best'));
            const mostLikelyMatch = predictiveInsights.scenarios.find(s => s.name.includes('Most Likely'));
            const worstCaseMatch = predictiveInsights.scenarios.find(s => s.name.includes('Worst'));

            // Extract numeric values from outcome text (e.g., "improves to 91%" -> 91)
            const extractValue = (outcome) => {
                const match = outcome.match(/(\d+\.?\d*)%/);
                if (match) return parseFloat(match[1]);
                // If no percentage, try to extract any number
                const numMatch = outcome.match(/(\d+\.?\d*)/);
                return numMatch ? parseFloat(numMatch[1]) : currentValue;
            };

            const bestValue = bestCaseMatch ? extractValue(bestCaseMatch.outcome) : currentValue * 1.05;
            const likelyValue = mostLikelyMatch ? extractValue(mostLikelyMatch.outcome) : currentValue;
            const worstValue = worstCaseMatch ? extractValue(worstCaseMatch.outcome) : currentValue * 0.95;

            // Get probabilities
            const bestProb = bestCaseMatch ? bestCaseMatch.probability : '25%';
            const likelyProb = mostLikelyMatch ? mostLikelyMatch.probability : '55%';
            const worstProb = worstCaseMatch ? worstCaseMatch.probability : '20%';

            window[`forecast_chart_${kpiId}`] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Current', predictiveInsights.timeframe || 'Forecast'],
                    datasets: [
                        {
                            label: `Best Case (${bestProb})`,
                            data: [currentValue, bestValue],
                            borderColor: '#10B981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#10B981'
                        },
                        {
                            label: `Most Likely (${likelyProb})`,
                            data: [currentValue, likelyValue],
                            borderColor: '#3B82F6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#3B82F6'
                        },
                        {
                            label: `Worst Case (${worstProb})`,
                            data: [currentValue, worstValue],
                            borderColor: '#EF4444',
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            borderWidth: 3,
                            borderDash: [5, 5],
                            fill: false,
                            tension: 0.4,
                            pointRadius: 5,
                            pointBackgroundColor: '#EF4444'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                font: {size: 11},
                                padding: 12,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.dataset.label || '';
                                    const value = context.parsed.y.toFixed(1);
                                    return `${label}: ${value}`;
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: `Pattern: ${predictiveInsights.pattern} (${predictiveInsights.confidence}% confidence)`,
                            font: {size: 12, weight: '600'},
                            color: '#374151',
                            padding: {bottom: 16}
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {color: 'rgba(0,0,0,0.05)'},
                            ticks: {
                                font: {size: 11},
                                color: '#6B7280',
                                callback: (value) => value.toFixed(1)
                            }
                        },
                        x: {
                            grid: {display: false},
                            ticks: {font: {size: 11}, color: '#6B7280'}
                        }
                    }
                }
            });
        }

        // Draw Neo4j-style Dependency Network Graph with D3.js
        function drawDependencyGraph(kpiId, dependencies) {
            const container = document.getElementById(`dependency-graph-${kpiId}`);
            if (!container) return;

            // Clear previous graph
            container.innerHTML = '';

            // Find the current KPI data
            const currentKPI = kpiData.nodes.find(k => k.id === kpiId);
            if (!currentKPI) return;

            // Build graph data structure
            const nodes = [{ id: kpiId, name: currentKPI.name, type: 'current', level: 0 }];
            const links = [];

            // Use dependencies from the new data structure (arrays of KPI names)
            const upstreamNames = dependencies.upstream || [];
            const downstreamNames = dependencies.downstream || [];

            // Helper function to find KPI by name with fuzzy matching
            function findKPIByName(depName) {
                // Try exact match first
                let found = kpiData.nodes.find(k => k.name === depName || k.name.replace(/\n/g, ' ') === depName);
                if (found) return found;
                
                // Try case-insensitive match
                const lowerDepName = depName.toLowerCase();
                found = kpiData.nodes.find(k => 
                    k.name.toLowerCase() === lowerDepName || 
                    k.name.toLowerCase().replace(/\n/g, ' ') === lowerDepName
                );
                if (found) return found;
                
                // Try partial match
                found = kpiData.nodes.find(k => 
                    k.name.toLowerCase().includes(lowerDepName) ||
                    lowerDepName.includes(k.name.toLowerCase())
                );
                return found;
            }

            // Add upstream nodes (causes) - match by name with fuzzy logic
            upstreamNames.forEach((upstreamName, index) => {
                const upstreamKPI = findKPIByName(upstreamName);
                if (upstreamKPI) {
                    // Only add if not already added (avoid duplicates)
                    if (!nodes.find(n => n.id === upstreamKPI.id)) {
                        nodes.push({
                            id: upstreamKPI.id,
                            name: upstreamKPI.name,
                            type: 'cause',
                            level: -1,
                            index: index
                        });
                        links.push({ source: upstreamKPI.id, target: kpiId, type: 'cause' });
                    }
                } else {
                    // Add as generic node if no matching KPI found
                    const genericId = `upstream-${index}-${kpiId}`;
                    nodes.push({
                        id: genericId,
                        name: upstreamName,
                        type: 'cause',
                        level: -1,
                        index: index,
                        isGeneric: true
                    });
                    links.push({ source: genericId, target: kpiId, type: 'cause' });
                }
            });

            // Add downstream nodes (effects)
            downstreamNames.forEach((downstreamName, index) => {
                const downstreamKPI = findKPIByName(downstreamName);
                if (downstreamKPI) {
                    // Only add if not already added
                    if (!nodes.find(n => n.id === downstreamKPI.id)) {
                        nodes.push({
                            id: downstreamKPI.id,
                            name: downstreamKPI.name,
                            type: 'effect',
                            level: 1,
                            index: index
                        });
                        links.push({ source: kpiId, target: downstreamKPI.id, type: 'effect' });
                    }
                } else {
                    // Add as generic node if no matching KPI found
                    const genericId = `downstream-${index}-${kpiId}`;
                    nodes.push({
                        id: genericId,
                        name: downstreamName,
                        type: 'effect',
                        level: 1,
                        index: index,
                        isGeneric: true
                    });
                    links.push({ source: kpiId, target: genericId, type: 'effect' });
                }
            });

            // If no dependencies at all, show message
            if (nodes.length === 1) {
                container.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #9CA3AF; font-size: 14px;">No dependencies data available</div>';
                return;
            }

            // Create SVG
            const width = container.clientWidth;
            const height = container.clientHeight;

            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Define arrow markers
            svg.append('defs').append('marker')
                .attr('id', `arrow-${kpiId}`)
                .attr('viewBox', '0 0 10 10')
                .attr('refX', 25)
                .attr('refY', 5)
                .attr('markerWidth', 6)
                .attr('markerHeight', 6)
                .attr('orient', 'auto')
                .append('path')
                .attr('d', 'M 0 0 L 10 5 L 0 10 z')
                .attr('class', 'dep-link-arrow');

            // Calculate positions (force-directed layout simulation)
            const simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(40));

            // Create links
            const link = svg.append('g')
                .selectAll('path')
                .data(links)
                .join('path')
                .attr('class', 'dep-link')
                .attr('marker-end', `url(#arrow-${kpiId})`);

            // Create node groups
            const node = svg.append('g')
                .selectAll('g')
                .data(nodes)
                .join('g')
                .attr('class', 'dep-node')
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended));

            // Add circles to nodes
            node.append('circle')
                .attr('class', 'dep-node-circle')
                .attr('r', d => d.type === 'current' ? 25 : (d.isGeneric ? 18 : 20))
                .attr('fill', d => {
                    if (d.type === 'current') return '#10B981';
                    if (d.isGeneric && d.type === 'cause') return '#94A3B8'; // Gray for generic upstream
                    if (d.isGeneric && d.type === 'effect') return '#CBD5E1'; // Light gray for generic downstream
                    if (d.type === 'cause') return '#60A5FA';
                    return '#F59E0B';
                })
                .attr('stroke', d => d.isGeneric ? '#64748B' : 'none')
                .attr('stroke-width', d => d.isGeneric ? 2 : 0)
                .attr('stroke-dasharray', d => d.isGeneric ? '4,2' : 'none');

            // Add text labels
            node.append('text')
                .attr('class', 'dep-node-text')
                .attr('dy', d => d.type === 'current' ? 40 : 35)
                .text(d => {
                    // Truncate long names
                    const maxLength = 20;
                    return d.name.length > maxLength ? d.name.substring(0, maxLength) + '...' : d.name;
                })
                .style('font-size', d => d.type === 'current' ? '12px' : '11px')
                .style('font-weight', d => d.type === 'current' ? 'bold' : '600');

            // Update positions on simulation tick
            simulation.on('tick', () => {
                link.attr('d', d => {
                    const dx = d.target.x - d.source.x;
                    const dy = d.target.y - d.source.y;
                    const dr = Math.sqrt(dx * dx + dy * dy);
                    return `M${d.source.x},${d.source.y}A${dr},${dr} 0 0,1 ${d.target.x},${d.target.y}`;
                });

                node.attr('transform', d => `translate(${d.x},${d.y})`);
            });

            // Drag functions
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }

            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }

            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }

            // Add hover effects
            node.on('mouseover', function(event, d) {
                d3.select(this).select('circle').transition().duration(200).attr('r', d.type === 'current' ? 30 : 25);
                
                // Highlight connected links
                link.classed('highlighted', l => l.source.id === d.id || l.target.id === d.id);
                svg.selectAll('.dep-link-arrow').classed('highlighted', l => l.source.id === d.id || l.target.id === d.id);
            })
            .on('mouseout', function(event, d) {
                d3.select(this).select('circle').transition().duration(200).attr('r', d.type === 'current' ? 25 : 20);
                
                // Remove highlight
                link.classed('highlighted', false);
                svg.selectAll('.dep-link-arrow').classed('highlighted', false);
            });
        }

        // Helper: Get cause dependencies for a KPI
        function getDependencyCauses(kpiId) {
            const causes = [];
            // Map common dependencies (based on business logic)
            const dependencyMap = {
                'ncr': ['dso', 'touchless_pct', 'automation_rate'],
                'dso': ['touchless_pct', 'automation_rate', 'cycle_time'],
                'op_margin': ['ncr', 'dso', 'monthly_revenue'],
                'monthly_revenue': ['nps', 'csat', 'cycle_time'],
                'cycle_time': ['touchless_pct', 'automation_rate', 'uptime'],
                'touchless_pct': ['automation_rate', 'data_quality_index', 'uptime'],
                'nps': ['cycle_time', 'csat', 'uptime'],
                'csat': ['cycle_time', 'touchless_pct', 'uptime']
            };
            return dependencyMap[kpiId] || [];
        }

        // Helper: Get effect dependencies for a KPI
        function getDependencyEffects(kpiId) {
            const effects = [];
            // Reverse lookup - find KPIs that depend on this KPI
            const dependencyMap = {
                'dso': ['ncr', 'op_margin'],
                'touchless_pct': ['ncr', 'dso', 'cycle_time', 'nps'],
                'automation_rate': ['ncr', 'dso', 'touchless_pct', 'cycle_time'],
                'cycle_time': ['monthly_revenue', 'nps', 'csat'],
                'nps': ['monthly_revenue'],
                'csat': ['monthly_revenue', 'nps'],
                'uptime': ['cycle_time', 'touchless_pct', 'nps', 'csat'],
                'data_quality_index': ['touchless_pct', 'automation_rate']
            };
            return dependencyMap[kpiId] || [];
        }

        // Helper: Determine trend class (positive/negative/neutral)
        function getTrendClass(trendValue) {
            if (!trendValue) return 'neutral';
            const numericValue = parseFloat(trendValue.toString().replace(/[^0-9.-]/g, ''));
            if (isNaN(numericValue)) return 'neutral';
            
            // For DSO and cycle_time, lower is better
            const kpiId = localStorage.getItem('selectedKPI');
            const inverseTrendKPIs = ['dso', 'cycle_time', 'api_error_rate', 'critical_defect', 'repurchase_rate'];
            
            if (inverseTrendKPIs.includes(kpiId)) {
                return numericValue < -0.1 ? 'positive' : numericValue > 0.1 ? 'negative' : 'neutral';
            }
            
            return numericValue > 0.1 ? 'positive' : numericValue < -0.1 ? 'negative' : 'neutral';
        }

        // Helper: Get trend arrow indicator
        function getTrendArrow(trendValue) {
            const trendClass = getTrendClass(trendValue);
            if (trendClass === 'positive') return '‚Üë';
            if (trendClass === 'negative') return '‚Üì';
            return '‚Üí';
        }

        // Draw Trend Sparkline Chart
        function drawTrendSparkline(kpiId) {
            const canvas = document.getElementById(`trend-sparkline-${kpiId}`);
            if (!canvas) return;

            // Get historical data from demo_dataset.csv
            const historicalData = getHistoricalData(kpiId);
            if (!historicalData || historicalData.length === 0) return;

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: historicalData.map(d => d.month),
                    datasets: [{
                        data: historicalData.map(d => d.value),
                        borderColor: '#2B5BA6',
                        backgroundColor: 'rgba(43, 91, 166, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 3,
                        pointHoverRadius: 5,
                        pointBackgroundColor: '#2B5BA6',
                        pointBorderColor: '#FFFFFF',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Value: ${context.parsed.y.toFixed(1)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { font: { size: 10 }, color: '#6B7280' }
                        },
                        y: {
                            display: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 10 }, color: '#6B7280' }
                        }
                    }
                }
            });
        }

        // Draw Forecast Chart
        function drawForecastChart(kpiId, forecast7, forecast30) {
            const canvas = document.getElementById(`forecast-chart-${kpiId}`);
            if (!canvas) return;

            const historicalData = getHistoricalData(kpiId);
            if (!historicalData || historicalData.length === 0) return;

            const lastValue = historicalData[historicalData.length - 1].value;
            const forecast7Val = parseFloat(forecast7?.toString().replace(/[^0-9.]/g, '')) || lastValue;
            const forecast30Val = parseFloat(forecast30?.toString().replace(/[^0-9.]/g, '')) || lastValue;

            const ctx = canvas.getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Current', '7 Days', '30 Days'],
                    datasets: [{
                        label: 'Forecast',
                        data: [lastValue, forecast7Val, forecast30Val],
                        borderColor: '#111B2E',
                        backgroundColor: 'rgba(17, 27, 46, 0.1)',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: '#2B5BA6',
                        pointBorderColor: '#FFFFFF',
                        pointBorderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `Projected: ${context.parsed.y.toFixed(1)}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            display: true,
                            grid: { display: false },
                            ticks: { font: { size: 11 }, color: '#6B7280' }
                        },
                        y: {
                            display: true,
                            grid: { color: 'rgba(0,0,0,0.05)' },
                            ticks: { font: { size: 11 }, color: '#6B7280' }
                        }
                    }
                }
            });
        }

        // Get historical data for a KPI from demo_dataset
        function getHistoricalData(kpiId) {
            // Historical data from demo_dataset.csv
            const dataset = {
                'ncr': [
                    { month: '2025-05', value: 96.8 },
                    { month: '2025-06', value: 96.5 },
                    { month: '2025-07', value: 96.4 },
                    { month: '2025-08', value: 96.2 },
                    { month: '2025-09', value: 96.1 },
                    { month: '2025-10', value: 96.2 }
                ],
                'dso': [
                    { month: '2025-05', value: 34 },
                    { month: '2025-06', value: 35 },
                    { month: '2025-07', value: 36 },
                    { month: '2025-08', value: 37 },
                    { month: '2025-09', value: 38 },
                    { month: '2025-10', value: 38 }
                ],
                'monthly_revenue': [
                    { month: '2025-05', value: 43.5 },
                    { month: '2025-06', value: 44.0 },
                    { month: '2025-07', value: 44.6 },
                    { month: '2025-08', value: 45.0 },
                    { month: '2025-09', value: 45.1 },
                    { month: '2025-10', value: 45.2 }
                ],
                'cycle_time': [
                    { month: '2025-05', value: 20 },
                    { month: '2025-06', value: 20 },
                    { month: '2025-07', value: 20 },
                    { month: '2025-08', value: 21 },
                    { month: '2025-09', value: 21 },
                    { month: '2025-10', value: 21 }
                ],
                'touchless_pct': [
                    { month: '2025-05', value: 58 },
                    { month: '2025-06', value: 60 },
                    { month: '2025-07', value: 61 },
                    { month: '2025-08', value: 62 },
                    { month: '2025-09', value: 63 },
                    { month: '2025-10', value: 63 }
                ],
                'nps': [
                    { month: '2025-05', value: 80 },
                    { month: '2025-06', value: 79 },
                    { month: '2025-07', value: 79 },
                    { month: '2025-08', value: 78 },
                    { month: '2025-09', value: 78 },
                    { month: '2025-10', value: 78 }
                ],
                'csat': [
                    { month: '2025-05', value: 90 },
                    { month: '2025-06', value: 91 },
                    { month: '2025-07', value: 91 },
                    { month: '2025-08', value: 92 },
                    { month: '2025-09', value: 92 },
                    { month: '2025-10', value: 92 }
                ]
            };

            return dataset[kpiId] || [];
        }

        // Close info panel
        function closeInfoPanel() {
            document.getElementById('infoPanel').classList.remove('visible');
        }

        // Show tooltip
        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            const kpi = d.data;
            
            // Check if node has children
            const hasChildren = d.children || d._children;
            const isExpanded = d.children ? true : false;
            
            let tooltipContent = `<div class="tooltip-title">${kpi.name}</div>`;
            
            if (hasChildren) {
                // Parent node tooltip
                tooltipContent += `
                    <div class="tooltip-row"><span class="tooltip-label">Status:</span> ${isExpanded ? 'Expanded' : 'Collapsed'}</div>
                    <div class="tooltip-row"><span class="tooltip-label">Value:</span> ${kpi.value}</div>
                    <div class="tooltip-row"><span class="tooltip-label">Target:</span> ${kpi.target}</div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E5E7EB; font-size: 11px; color: #6B7280;">
                        üí° <strong>Click</strong> to ${isExpanded ? 'collapse' : 'expand'}<br>
                        üí° <strong>Shift+Click</strong> for details
                    </div>
                `;
            } else {
                // Leaf node tooltip
                const currentValue = window.KPIStore.getValue(kpi.id);
                const displayValue = formatKPIValue(kpi.id, currentValue);
                
                tooltipContent += `
                    <div class="tooltip-row"><span class="tooltip-label">Value:</span> ${displayValue}</div>
                    <div class="tooltip-row"><span class="tooltip-label">Target:</span> ${kpi.target}</div>
                    <div class="tooltip-row"><span class="tooltip-label">Trend:</span> ${kpi.trend || 'N/A'}</div>
                    <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #E5E7EB; font-size: 11px; color: #6B7280;">
                        üí° <strong>Click</strong> or <strong>Shift+Click</strong> for details
                    </div>
                `;
            }

            tooltip.innerHTML = tooltipContent;
            tooltip.style.left = event.pageX + 15 + 'px';
            tooltip.style.top = event.pageY - 15 + 'px';
            tooltip.classList.add('visible');
        }

        // Hide tooltip
        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        // Zoom controls
        function zoomIn() {
            svg.transition().duration(300).call(zoom.scaleBy, 1.3);
        }

        function zoomOut() {
            svg.transition().duration(300).call(zoom.scaleBy, 0.7);
        }

        function centerGraph() {
            const container = document.getElementById('tree-scroll-wrapper');
            const height = container.offsetHeight;
            
            svg.transition().duration(500).call(
                zoom.transform,
                d3.zoomIdentity.translate(120, height / 2).scale(1)
            );
        }

        // Expand/collapse
        function expandAll() {
            root.descendants().forEach(d => {
                if (d._children) {
                    d.children = d._children;
                    d._children = null;
                }
            });
            updateTree(root);
            setTimeout(() => centerGraph(), 500);
        }

        function collapseAll() {
            root.descendants().forEach(d => {
                if (d.depth > 1 && d.children) {
                    d._children = d.children;
                    d.children = null;
                }
            });
            updateTree(root);
            setTimeout(() => centerGraph(), 500);
        }

        // Refresh data
        function refreshData() {
            loadKPIData();
            addChatMessage('ai', '<strong>Data Refreshed!</strong>All KPI values updated. The tree has been reloaded with the latest metrics.');
        }

        // Chat functionality
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addChatMessage('user', message);
            input.value = '';

            setTimeout(() => {
                processAIQuery(message);
            }, 500);
        }

        function togglePrompts() {
            const promptButtons = document.getElementById('promptButtons');
            const collapseBtn = document.getElementById('collapseBtn');
            
            if (promptButtons.classList.contains('collapsed')) {
                // Expand
                promptButtons.classList.remove('collapsed');
                collapseBtn.textContent = '‚ñº';
                collapseBtn.title = 'Collapse Quick Questions';
            } else {
                // Collapse
                promptButtons.classList.add('collapsed');
                collapseBtn.textContent = '‚ñ∂';
                collapseBtn.title = 'Expand Quick Questions';
            }
        }

        function askQuestion(question) {
            console.log('askQuestion called with:', question);
            console.log('kpiData status:', kpiData ? 'Loaded' : 'Not loaded');
            
            addChatMessage('user', question);
            setTimeout(() => {
                processAIQuery(question);
            }, 500);
        }

        function addChatMessage(type, content, saveToStore = true) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.innerHTML = content;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            if (saveToStore) {
                window.ChatStore.addMessage(type, content);
            }
        }

        function processAIQuery(query) {
            console.log('processAIQuery called with:', query);
            const lowerQuery = query.toLowerCase();

            // Check if kpiData is loaded
            if (!kpiData || !kpiData.nodes) {
                console.error('kpiData not loaded!', {kpiData: kpiData});
                addChatMessage('ai', `
                    <strong>‚è≥ Loading Data...</strong>
                    <p>The KPI data is still loading. Please wait a moment and try again.</p>
                    <p style="font-size: 12px; color: #666;">Debug: kpiData status = ${kpiData ? 'Exists but no nodes' : 'Null'}</p>
                `);
                return;
            }
            
            console.log('kpiData loaded, total nodes:', kpiData.nodes.length);

            // Helper function to find KPI by name or ID (case-insensitive)
            function findKPI(searchTerm) {
                return kpiData.nodes.find(n => 
                    n.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    n.name.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }

            // Helper function to get RAG color
            function getRAGColor(rag) {
                if (rag === 'red') return '#EF4444';
                if (rag === 'amber') return '#F59E0B';
                return '#10B981';
            }

            // Helper function to format number
            function formatNumber(num) {
                if (typeof num === 'string') return num; // Already formatted
                if (num >= 1000000) return `$${(num / 1000000).toFixed(1)}M`;
                if (num >= 1000) return `$${(num / 1000).toFixed(0)}K`;
                return `$${num.toFixed(0)}`;
            }

            // Helper function to format value (handles both strings and numbers)
            function formatValue(value) {
                if (typeof value === 'string') return value;
                if (typeof value === 'number') return value.toFixed(1);
                return String(value);
            }

            // COLLECTION EFFICIENCY QUERIES
            if (lowerQuery.includes('collection') && (lowerQuery.includes('efficiency') || lowerQuery.includes('status'))) {
                const collectionEff = findKPI('collection_efficiency');
                const expectedCollection = findKPI('expected_collection_rate');
                const cashCollection = findKPI('cash_collection_rate');
                
                if (collectionEff) {
                    const ragColor = getRAGColor(collectionEff.rag);
                    const trend = collectionEff.trend_data && collectionEff.trend_data.length > 0 ? collectionEff.trend_data : [];
                    const trendDirection = collectionEff.trend === 'up' ? 'üìà Improving' : collectionEff.trend === 'down' ? 'üìâ Declining' : '‚û°Ô∏è Stable';
                    
                    addChatMessage('ai', `
                        <strong>üí∞ Collection Efficiency Status</strong>
                        <div style="background: ${ragColor}15; border-left: 4px solid ${ragColor}; padding: 12px; margin: 10px 0; border-radius: 4px;">
                            <p><strong>Current Performance:</strong> ${formatValue(collectionEff.value)} (Target: ${collectionEff.target})</p>
                            <p><strong>Status:</strong> <span style="color: ${ragColor}; font-weight: bold;">${collectionEff.rag.toUpperCase()}</span> ${trendDirection}</p>
                        </div>
                        
                        <p><strong>üìä Related Metrics:</strong></p>
                        <ul>
                            <li><strong>Expected Collection Rate:</strong> ${expectedCollection ? formatValue(expectedCollection.value) : 'N/A'}</li>
                            <li><strong>Cash Collection Rate:</strong> ${cashCollection ? formatValue(cashCollection.value) : 'N/A'}</li>
                        </ul>
                        
                        <p><strong>üéØ Context & Impact:</strong></p>
                        <p>${collectionEff.context_and_business_impact || 'Critical metric for revenue optimization'}</p>
                        
                        <p><strong>üí° Recommended Actions:</strong></p>
                        <ul>
                            ${collectionEff.recommended_actions ? collectionEff.recommended_actions.map(a => `<li><strong>${a.priority || 'Medium'}:</strong> ${a.action || a}</li>`).join('') : '<li>Review collection processes</li>'}
                        </ul>
                        
                        <p style="margin-top: 12px; padding: 8px; background: #FEF3C7; border-radius: 4px; font-size: 13px;">
                            <strong>üíº Team Contact:</strong> Sarah Martinez (VP Revenue Cycle) can provide detailed insights<br>
                            üìç <a href="command-center.html" style="color: #2B5BA6;">View in Command Center</a> | 
                            <a href="control-center.html" style="color: #2B5BA6;">Simulate Scenarios</a>
                        </p>
                    `);
                } else {
                    addChatMessage('ai', `
                        <strong>üí∞ Collection Efficiency - Not Found</strong>
                        <p>I couldn't find the Collection Efficiency KPI in the current data. This might be labeled differently in the system.</p>
                        <p>Try asking about specific collection metrics or view the <a href="command-center.html" style="color: #2B5BA6;">Command Center</a> for all available KPIs.</p>
                    `);
                }
            }
            
            // DSO PERFORMANCE QUERIES
            else if (lowerQuery.includes('dso') && (lowerQuery.includes('performance') || lowerQuery.includes('trend') || lowerQuery.includes('show'))) {
                const dso = findKPI('dso') || findKPI('days_sales_outstanding');
                
                if (dso) {
                    const ragColor = getRAGColor(dso.rag);
                    const trendData = dso.trend_data || [];
                    const dsoValue = typeof dso.value === 'number' ? dso.value : parseFloat(dso.value);
                    const latestTrend = trendData.length > 0 ? trendData[trendData.length - 1].value : dsoValue;
                    const previousTrend = trendData.length > 1 ? trendData[trendData.length - 2].value : dsoValue;
                    const trendChange = latestTrend - previousTrend;
                    
                    addChatMessage('ai', `
                        <strong>üìä DSO Performance Analysis</strong>
                        <div style="background: ${ragColor}15; border-left: 4px solid ${ragColor}; padding: 12px; margin: 10px 0; border-radius: 4px;">
                            <p><strong>Current DSO:</strong> ${formatValue(dso.value)} days (Target: ${dso.target} days)</p>
                            <p><strong>Status:</strong> <span style="color: ${ragColor}; font-weight: bold;">${dso.rag.toUpperCase()}</span></p>
                            <p><strong>Monthly Change:</strong> ${trendChange > 0 ? '+' : ''}${trendChange.toFixed(1)} days</p>
                        </div>
                        
                        <p><strong>üìà 6-Month Trend:</strong></p>
                        <ul>
                            ${trendData.slice(-6).map(t => `<li>${t.month}: ${t.value.toFixed(1)} days</li>`).join('')}
                        </ul>
                        
                        <p><strong>üîç Root Causes:</strong></p>
                        <ul>
                            ${dso.root_causes ? dso.root_causes.slice(0, 3).map(rc => `<li><strong>${rc.cause}</strong> (${rc.impact} impact, ${rc.confidence} confidence)</li>`).join('') : '<li>Analyzing data...</li>'}
                        </ul>
                        
                        <p><strong>üîó Key Dependencies:</strong></p>
                        <ul>
                            ${dso.dependencies && dso.dependencies.upstream ? dso.dependencies.upstream.slice(0, 3).map(dep => `<li>${dep}</li>`).join('') : '<li>Clean Claim Rate</li><li>Denial Processing Time</li><li>Payment Posting Speed</li>'}
                        </ul>
                        
                        <p><strong>üîÆ Predictive Insights:</strong></p>
                        <ul>
                            ${dso.predictive_insights && dso.predictive_insights.scenarios ? dso.predictive_insights.scenarios.map(s => `<li><strong>${s.name}:</strong> ${s.outcome} (${s.probability} probability)</li>`).join('') : '<li>Forecast available in detail panel</li>'}
                        </ul>
                        
                        <p style="margin-top: 12px; padding: 8px; background: #DBEAFE; border-radius: 4px; font-size: 13px;">
                            <strong>üíº Responsible Team:</strong> Maria Garcia (Director of AR Management)<br>
                            üéØ <strong>Action:</strong> Click DSO node in tree graph for full 10-layer intelligence analysis
                        </p>
                    `);
                }
            }
            
            // DENIAL RATE QUERIES
            else if (lowerQuery.includes('denial') && (lowerQuery.includes('rate') || lowerQuery.includes('analyz') || lowerQuery.includes('issue'))) {
                const denialRate = findKPI('denial_rate');
                const denials = findKPI('denials');
                const kpiToAnalyze = denialRate || denials;
                
                if (kpiToAnalyze) {
                    const ragColor = getRAGColor(kpiToAnalyze.rag);
                    
                    addChatMessage('ai', `
                        <strong>‚ö†Ô∏è Denial Rate Analysis</strong>
                        <div style="background: ${ragColor}15; border-left: 4px solid ${ragColor}; padding: 12px; margin: 10px 0; border-radius: 4px;">
                            <p><strong>Current Denial Rate:</strong> ${kpiToAnalyze.value.toFixed(1)}% (Target: ${kpiToAnalyze.target}%)</p>
                            <p><strong>Status:</strong> <span style="color: ${ragColor}; font-weight: bold;">${kpiToAnalyze.rag.toUpperCase()}</span></p>
                        </div>
                        
                        <p><strong>üîç Root Cause Analysis:</strong></p>
                        <ul>
                            ${kpiToAnalyze.root_causes ? kpiToAnalyze.root_causes.map(rc => `
                                <li>
                                    <strong>${rc.cause}</strong><br>
                                    <span style="font-size: 12px; color: #6B7280;">
                                        Impact: ${rc.impact} | Confidence: ${rc.confidence} | Data Points: ${rc.data_points || 'N/A'}
                                    </span>
                                </li>
                            `).join('') : '<li>Coding errors and eligibility verification gaps</li>'}
                        </ul>
                        
                        <p><strong>üìä Trend Analysis:</strong></p>
                        <p>${kpiToAnalyze.trend_analysis ? kpiToAnalyze.trend_analysis.pattern || 'Monitoring for patterns' : 'Review historical data in detail panel'}</p>
                        
                        <p><strong>üí° Recommended Actions (Priority Order):</strong></p>
                        <ol>
                            ${kpiToAnalyze.recommended_actions ? kpiToAnalyze.recommended_actions.map(a => `<li><strong>${a.priority || ''}:</strong> ${a.action || a}</li>`).join('') : '<li>Enhance pre-claim eligibility verification</li><li>Provide coding team additional training</li><li>Implement automated denial tracking</li>'}
                        </ol>
                        
                        <p><strong>üéØ Contributing Factors:</strong></p>
                        <ul>
                            ${kpiToAnalyze.contributing_factors ? kpiToAnalyze.contributing_factors.slice(0, 4).map(f => `<li>${f}</li>`).join('') : '<li>Insurance eligibility changes</li><li>Documentation completeness issues</li>'}
                        </ul>
                        
                        <p style="margin-top: 12px; padding: 8px; background: #FEE2E2; border-radius: 4px; font-size: 13px;">
                            <strong>üö® High Priority:</strong> Denials directly impact revenue and DSO<br>
                            <strong>üíº Contact:</strong> Michael Thompson (Director of Revenue Operations)<br>
                            üîß Try the <a href="control-center.html" style="color: #2B5BA6;">Control Center</a> to simulate denial reduction impact
                        </p>
                    `);
                }
            }
            
            // TOP AT-RISK KPIs
            else if (lowerQuery.includes('top') && (lowerQuery.includes('risk') || lowerQuery.includes('at-risk'))) {
                const redKPIs = kpiData.nodes.filter(n => n.rag === 'red' && n.id !== 'rcm_root');
                const amberKPIs = kpiData.nodes.filter(n => n.rag === 'amber');
                const atRiskKPIs = [...redKPIs.slice(0, 3), ...amberKPIs.slice(0, 2)];
                
                addChatMessage('ai', `
                    <strong>üö® Top 5 At-Risk KPIs</strong>
                    <p style="color: #DC2626; font-weight: bold;">‚ö†Ô∏è These metrics require immediate attention:</p>
                    
                    <ol>
                        ${atRiskKPIs.slice(0, 5).map((kpi, idx) => {
                            const ragColor = getRAGColor(kpi.rag);
                            const topRootCause = kpi.root_causes && kpi.root_causes.length > 0 ? kpi.root_causes[0].cause : 'Under investigation';
                            return `
                                <li style="margin-bottom: 15px; padding: 10px; background: ${ragColor}10; border-left: 3px solid ${ragColor}; border-radius: 4px;">
                                    <strong>${kpi.name}</strong><br>
                                    <span style="color: ${ragColor}; font-weight: bold;">${kpi.rag.toUpperCase()}</span> - 
                                    Current: ${typeof kpi.value === 'number' ? kpi.value.toFixed(1) : kpi.value} | 
                                    Target: ${kpi.target}<br>
                                    <span style="font-size: 12px; color: #6B7280;">Primary Issue: ${topRootCause}</span>
                                </li>
                            `;
                        }).join('')}
                    </ol>
                    
                    <p><strong>üìã Executive Summary:</strong></p>
                    <ul>
                        <li><strong>Red KPIs:</strong> ${redKPIs.length} metrics in critical state</li>
                        <li><strong>Amber KPIs:</strong> ${amberKPIs.length} metrics need attention</li>
                        <li><strong>Green KPIs:</strong> ${kpiData.nodes.filter(n => n.rag === 'green').length} metrics on target</li>
                    </ul>
                    
                    <p style="margin-top: 12px; padding: 8px; background: #FEF3C7; border-radius: 4px;">
                        <strong>üéØ Next Steps:</strong> Review each KPI's detail panel for specific action plans<br>
                        <strong>üíº Executive Contact:</strong> Robert Chen (CEO) oversees priority resolution<br>
                        üìä Visit <a href="command-center.html" style="color: #2B5BA6;">Command Center</a> for complete KPI matrix
                    </p>
                `);
            }
            
            // REVENUE PREDICTIONS
            else if (lowerQuery.includes('revenue') && (lowerQuery.includes('predict') || lowerQuery.includes('forecast'))) {
                const expectedRev = findKPI('expected_revenue');
                const billedRev = findKPI('billed_revenue');
                const revenuePerf = findKPI('revenue_performance');
                const kpiToAnalyze = expectedRev || revenuePerf || billedRev;
                
                if (kpiToAnalyze) {
                    const ragColor = getRAGColor(kpiToAnalyze.rag);
                    const predictions = kpiToAnalyze.predictive_insights;
                    
                    addChatMessage('ai', `
                        <strong>üîÆ Revenue Predictive Insights</strong>
                        <div style="background: ${ragColor}15; border-left: 4px solid ${ragColor}; padding: 12px; margin: 10px 0; border-radius: 4px;">
                            <p><strong>Current Revenue Status:</strong> ${typeof kpiToAnalyze.value === 'number' ? formatNumber(kpiToAnalyze.value) : kpiToAnalyze.value.toFixed(1) + '%'}</p>
                            <p><strong>Status:</strong> <span style="color: ${ragColor}; font-weight: bold;">${kpiToAnalyze.rag.toUpperCase()}</span></p>
                        </div>
                        
                        <p><strong>üéØ Predictive Analysis (${predictions ? predictions.timeframe : 'Next 90 days'}):</strong></p>
                        <p><strong>Pattern:</strong> ${predictions ? predictions.pattern : 'Analyzing trends'} (${predictions ? predictions.confidence + '% confidence' : 'High confidence'})</p>
                        
                        <p><strong>üìä Scenario Forecasts:</strong></p>
                        <ul>
                            ${predictions && predictions.scenarios ? predictions.scenarios.map(s => `
                                <li style="margin-bottom: 8px;">
                                    <strong>${s.name}:</strong> ${s.outcome}<br>
                                    <span style="font-size: 12px; color: #6B7280;">Probability: ${s.probability}</span>
                                </li>
                            `).join('') : '<li>Best Case: 5-8% improvement</li><li>Most Likely: Maintain current level</li><li>Worst Case: 2-3% decline</li>'}
                        </ul>
                        
                        <p><strong>üìà Leading Indicators:</strong></p>
                        <ul>
                            ${predictions && predictions.leading_indicators ? predictions.leading_indicators.slice(0, 4).map(ind => `<li>${ind}</li>`).join('') : '<li>Collection efficiency trending</li><li>Claim acceptance rates</li><li>Payer mix optimization</li>'}
                        </ul>
                        
                        <p><strong>‚ö° Risk Factors:</strong></p>
                        <ul>
                            ${predictions && predictions.risk_factors ? predictions.risk_factors.slice(0, 3).map(risk => `<li>${risk}</li>`).join('') : '<li>Seasonal volume fluctuations</li><li>Payer policy changes</li><li>Staffing capacity</li>'}
                        </ul>
                        
                        <p style="margin-top: 12px; padding: 8px; background: #DBEAFE; border-radius: 4px; font-size: 13px;">
                            <strong>üí° Strategic Insight:</strong> Focus on collection efficiency and denial prevention for revenue optimization<br>
                            <strong>üíº Financial Leadership:</strong> John Anderson (CFO)<br>
                            üìä Click on Revenue nodes in tree graph to see predictive forecast charts
                        </p>
                    `);
                }
            }
            
            // AR MANAGEMENT TEAM
            else if (lowerQuery.includes('who') && lowerQuery.includes('ar')) {
                addChatMessage('ai', `
                    <strong>üë• AR Management Team</strong>
                    
                    <div style="background: #F0F9FF; padding: 15px; border-radius: 8px; margin: 10px 0;">
                        <p><strong>üéØ Primary Leadership:</strong></p>
                        <ul>
                            <li>
                                <strong>Maria Garcia</strong> - Director of AR Management<br>
                                <span style="font-size: 12px; color: #6B7280;">Overall AR strategy and performance oversight</span>
                            </li>
                            <li>
                                <strong>Christopher Lee</strong> - AR Manager<br>
                                <span style="font-size: 12px; color: #6B7280;">Day-to-day AR operations and team management</span>
                            </li>
                            <li>
                                <strong>Amanda Taylor</strong> - AR Specialist<br>
                                <span style="font-size: 12px; color: #6B7280;">Account follow-up and resolution execution</span>
                            </li>
                        </ul>
                    </div>
                    
                    <p><strong>üìä Key Responsibilities:</strong></p>
                    <ul>
                        <li>Days Sales Outstanding (DSO) management</li>
                        <li>Total AR balance optimization</li>
                        <li>AR aging analysis and reduction</li>
                        <li>Bad debt prevention strategies</li>
                        <li>Collection efficiency improvement</li>
                    </ul>
                    
                    <p><strong>üéØ Current KPI Ownership:</strong></p>
                    <ul>
                        <li><strong>DSO:</strong> Target 45 days</li>
                        <li><strong>Total AR Balance:</strong> Monitoring thresholds</li>
                        <li><strong>AR Aging >90 days:</strong> Minimize outstanding</li>
                        <li><strong>Bad Debt Rate:</strong> Keep below 2%</li>
                    </ul>
                    
                    <p style="margin-top: 12px; padding: 8px; background: #FEF3C7; border-radius: 4px;">
                        <strong>üí° Tip:</strong> Visit <a href="people-graph.html" style="color: #2B5BA6;">People Graph</a> to see complete organizational structure and KPI ownership mapping<br>
                        üìû Click on any employee node to see their contact info and assigned KPIs
                    </p>
                `);
            }
            
            // CASH COLLECTION DEPENDENCIES
            else if (lowerQuery.includes('depend') && lowerQuery.includes('cash')) {
                const cashCollection = findKPI('cash_collection_rate');
                
                if (cashCollection && cashCollection.dependencies) {
                    addChatMessage('ai', `
                        <strong>üîó Cash Collection Dependencies</strong>
                        
                        <div style="background: #10B98115; border-left: 4px solid #10B981; padding: 12px; margin: 10px 0; border-radius: 4px;">
                            <p><strong>Current Cash Collection Rate:</strong> ${cashCollection.value.toFixed(1)}% (Target: ${cashCollection.target}%)</p>
                            <p><strong>Status:</strong> <span style="color: ${getRAGColor(cashCollection.rag)}; font-weight: bold;">${cashCollection.rag.toUpperCase()}</span></p>
                        </div>
                        
                        <p><strong>‚¨ÜÔ∏è Upstream Dependencies (What Affects Cash Collection):</strong></p>
                        <ul>
                            ${cashCollection.dependencies.upstream ? cashCollection.dependencies.upstream.map(dep => `<li>${dep}</li>`).join('') : '<li>Billing accuracy</li><li>Payer response time</li><li>Claim clean rate</li>'}
                        </ul>
                        
                        <p><strong>‚¨áÔ∏è Downstream Impact (What Cash Collection Affects):</strong></p>
                        <ul>
                            ${cashCollection.dependencies.downstream ? cashCollection.dependencies.downstream.map(dep => `<li>${dep}</li>`).join('') : '<li>Days cash on hand</li><li>Operating cash flow</li><li>Revenue performance</li>'}
                        </ul>
                        
                        <p><strong>üîç Relationship Insights:</strong></p>
                        <p>${cashCollection.context_and_business_impact || 'Cash collection rate is a critical indicator of revenue cycle health, directly impacting organizational liquidity and operational capabilities.'}</p>
                        
                        <p><strong>üí° Optimization Strategy:</strong></p>
                        <ul>
                            ${cashCollection.recommended_actions ? cashCollection.recommended_actions.slice(0, 3).map(a => `<li>${a.action || a}</li>`).join('') : '<li>Accelerate payment posting</li><li>Improve payer contract terms</li><li>Enhance follow-up processes</li>'}
                        </ul>
                        
                        <p style="margin-top: 12px; padding: 8px; background: #DBEAFE; border-radius: 4px;">
                            <strong>üéØ Interactive Analysis:</strong> Visit <a href="control-center.html" style="color: #2B5BA6;">Control Center</a> to adjust cash collection rate and see real-time cascading effects on 35+ related metrics<br>
                            üíº <strong>Contact:</strong> Lisa Johnson (Director of Cash Management)
                        </p>
                    `);
                }
            }
            
            // BAD DEBT RECOMMENDATIONS
            else if (lowerQuery.includes('bad debt') || (lowerQuery.includes('recommend') && lowerQuery.includes('debt'))) {
                const badDebtRate = findKPI('bad_debt_rate');
                
                if (badDebtRate) {
                    const ragColor = getRAGColor(badDebtRate.rag);
                    
                    addChatMessage('ai', `
                        <strong>üí° Bad Debt Reduction Recommendations</strong>
                        
                        <div style="background: ${ragColor}15; border-left: 4px solid ${ragColor}; padding: 12px; margin: 10px 0; border-radius: 4px;">
                            <p><strong>Current Bad Debt Rate:</strong> ${badDebtRate.value.toFixed(1)}% (Target: ${badDebtRate.target}%)</p>
                            <p><strong>Status:</strong> <span style="color: ${ragColor}; font-weight: bold;">${badDebtRate.rag.toUpperCase()}</span></p>
                        </div>
                        
                        <p><strong>üéØ Prioritized Action Plan:</strong></p>
                        <ol>
                            ${badDebtRate.recommended_actions ? badDebtRate.recommended_actions.map(a => `
                                <li style="margin-bottom: 10px;">
                                    <strong>${a.priority || 'Priority'}:</strong> ${a.action || a}<br>
                                    ${a.expected_impact ? `<span style="font-size: 12px; color: #059669;">Expected Impact: ${a.expected_impact}</span>` : ''}
                                </li>
                            `).join('') : '<li>Enhance upfront eligibility verification</li><li>Implement patient payment plans</li><li>Improve collection processes</li><li>Review write-off policies</li>'}
                        </ol>
                        
                        <p><strong>üîç Root Causes to Address:</strong></p>
                        <ul>
                            ${badDebtRate.root_causes ? badDebtRate.root_causes.map(rc => `
                                <li>${rc.cause} <span style="color: #6B7280; font-size: 12px;">(${rc.impact} impact, ${rc.confidence} confidence)</span></li>
                            `).join('') : '<li>Patient financial capability</li><li>Insurance verification gaps</li><li>Collection follow-up delays</li>'}
                        </ul>
                        
                        <p><strong>üìä Expected Outcomes:</strong></p>
                        ${badDebtRate.predictive_insights && badDebtRate.predictive_insights.scenarios ? `
                            <ul>
                                ${badDebtRate.predictive_insights.scenarios.filter(s => s.name.includes('Best') || s.name.includes('Most Likely')).map(s => `
                                    <li><strong>${s.name}:</strong> ${s.outcome}</li>
                                `).join('')}
                            </ul>
                        ` : '<p>With focused intervention, expect 0.5-1.0% reduction in 90 days</p>'}
                        
                        <p><strong>üíº Team Accountability:</strong></p>
                        <ul>
                            ${badDebtRate.people_accountable ? badDebtRate.people_accountable.map(p => `
                                <li><strong>${p.name}</strong> - ${p.role} (${p.contact})</li>
                            `).join('') : '<li>Emily Davis - Director of Collections</li><li>James Wilson - Collections Manager</li>'}
                        </ul>
                        
                        <p style="margin-top: 12px; padding: 8px; background: #FEF3C7; border-radius: 4px;">
                            <strong>‚ö° Quick Win:</strong> Focus on pre-service verification and patient financial counseling<br>
                            <strong>üìà Monitor:</strong> Track bad debt rate weekly and review trends in <a href="command-center.html" style="color: #2B5BA6;">Command Center</a>
                        </p>
                    `);
                }
            }
            
            // GENERAL HELP / FALLBACK
            else {
                // Try to find any KPI that matches the query
                let matchedKPI = null;
                for (let node of kpiData.nodes) {
                    if (lowerQuery.includes(node.id.toLowerCase()) || 
                        lowerQuery.includes(node.name.toLowerCase().replace(/\n/g, ' '))) {
                        matchedKPI = node;
                        break;
                    }
                }
                
                if (matchedKPI) {
                    const ragColor = getRAGColor(matchedKPI.rag);
                    addChatMessage('ai', `
                        <strong>üìä ${matchedKPI.name} - Quick Overview</strong>
                        
                        <div style="background: ${ragColor}15; border-left: 4px solid ${ragColor}; padding: 12px; margin: 10px 0; border-radius: 4px;">
                            <p><strong>Current Value:</strong> ${formatValue(matchedKPI.value)}</p>
                            <p><strong>Target:</strong> ${matchedKPI.target}</p>
                            <p><strong>Status:</strong> <span style="color: ${ragColor}; font-weight: bold;">${matchedKPI.rag.toUpperCase()}</span></p>
                            <p><strong>Trend:</strong> ${matchedKPI.trend === 'up' ? 'üìà Improving' : matchedKPI.trend === 'down' ? 'üìâ Declining' : '‚û°Ô∏è Stable'}</p>
                        </div>
                        
                        <p><strong>üí° Context:</strong></p>
                        <p>${matchedKPI.context_and_business_impact || matchedKPI.current_state_analysis || 'Click the KPI node in the tree graph for detailed analysis'}</p>
                        
                        <p style="margin-top: 12px; padding: 8px; background: #F3F4F6; border-radius: 4px; font-size: 13px;">
                            <strong>üîç For Complete Analysis:</strong> Click on "${matchedKPI.name}" in the tree graph to see all 10 intelligence layers including:<br>
                            ‚Ä¢ Root cause analysis ‚Ä¢ Predictive insights ‚Ä¢ Dependencies ‚Ä¢ Team accountability ‚Ä¢ Recommended actions
                        </p>
                    `);
                } else {
                    // Generic help response
                    addChatMessage('ai', `
                        <strong>ü§ñ AI Executive Advisor Help</strong>
                        <p>I can help you with comprehensive Healthcare RCM analysis! I have access to all 101 KPIs with complete 10-layer intelligence.</p>
                        
                        <p><strong>üí¨ Try asking me:</strong></p>
                        <ul>
                            <li>"What is our current collection efficiency status?"</li>
                            <li>"Show me DSO performance and trends"</li>
                            <li>"Analyze denial rate issues"</li>
                            <li>"What are our top 5 at-risk KPIs?"</li>
                            <li>"Show me predictive insights for revenue"</li>
                            <li>"Who is responsible for AR management?"</li>
                            <li>"What dependencies affect cash collection?"</li>
                            <li>"Recommend actions for bad debt reduction"</li>
                        </ul>
                        
                        <p><strong>üéØ I can provide:</strong></p>
                        <ul>
                            <li>‚úÖ Real-time KPI values and RAG status</li>
                            <li>‚úÖ 6-month historical trend analysis</li>
                            <li>‚úÖ Root cause identification with confidence scores</li>
                            <li>‚úÖ Predictive scenarios (Best/Likely/Worst case)</li>
                            <li>‚úÖ Dependency mapping and cascade effects</li>
                            <li>‚úÖ Team accountability and contacts</li>
                            <li>‚úÖ Prioritized recommended actions</li>
                            <li>‚úÖ Cross-dashboard navigation</li>
                        </ul>
                        
                        <p style="margin-top: 12px; padding: 8px; background: #F0F9FF; border-radius: 4px;">
                            <strong>üöÄ Quick Navigation:</strong><br>
                            üìä <a href="command-center.html" style="color: #2B5BA6;">Command Center</a> - Complete KPI matrix view<br>
                            üéõÔ∏è <a href="control-center.html" style="color: #2B5BA6;">Control Center</a> - What-if simulations with 99 KPI sliders<br>
                            üë• <a href="people-graph.html" style="color: #2B5BA6;">People Graph</a> - Organizational hierarchy and KPI ownership<br>
                            üå≥ Tree Graph (this page) - Hierarchical KPI visualization with 10-layer intelligence
                        </p>
                        
                        <p><strong>üí° Pro Tip:</strong> Use the Quick Questions buttons above or ask about any specific KPI by name!</p>
                    `);
                }
            }
        }

        // Initialize
        window.addEventListener('load', loadKPIData);

        // Handle resize
        window.addEventListener('resize', () => {
            if (kpiData) {
                initializeTreeGraph();
            }
        });

        // Listen for cross-page KPI updates
        window.addEventListener('storage', (e) => {
            if (e.key === 'KPIStore') {
                const newStore = JSON.parse(e.newValue || '{}');
                if (newStore.values) {
                    Object.keys(newStore.values).forEach(kpiId => {
                        const newValue = newStore.values[kpiId];
                        if (newValue !== window.KPIStore.values[kpiId]) {
                            window.KPIStore.values[kpiId] = newValue;
                            updateNodeValue(kpiId, newValue);
                        }
                    });
                }
            }
        });
    </script>
</body>
</html>
